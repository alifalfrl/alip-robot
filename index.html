<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alip AI - Cerdas & Premium</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Balsamiq+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* ========================================= */
        /* 1. CSS VARIABLES             */
        /* ========================================= */

        :root {
            --bg-primary: #f0f2f5;
            --bg-secondary: #ffffff;
            --bg-tertiary: #fafafa;
            --text-color: #333;
            --text-muted: #888;
            --accent-color: #5d5dff;
            --accent-hover: #4a4afe;
            --border-color: #e0e0e0;
            --input-bg: #f8f9fa;
            --message-bg-user: #5d5dff;
            --message-text-user: #ffffff;
            --message-bg-bot: #e9e9e9;
            --message-text-bot: #333;
            --success-color: #28a745;
            --error-color: #dc3545;
            --warning-color: #ffc107;
            --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.08);
            --shadow-heavy: 0 12px 40px rgba(0, 0, 0, 0.15);
            --border-radius-sm: 8px;
            --border-radius-md: 20px;
            --border-radius-lg: 28px;
        }

        /* ========================================= */
        /* 2. DARK MODE STYLES            */
        /* ========================================= */

        body.dark-mode {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --bg-tertiary: #2a2a2a;
            --text-color: #e0e0e0;
            --text-muted: #b0b0b0;
            --accent-color: #8c8cff;
            --accent-hover: #a1a1ff;
            --border-color: #333;
            --input-bg: #2a2a2a;
            --message-bg-user: #8c8cff;
            --message-text-user: #121212;
            --message-bg-bot: #3a3a3a;
            --message-text-bot: #e0e0e0;
            --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.3);
            --shadow-heavy: 0 12px 40px rgba(0, 0, 0, 0.5);
        }

        /* ========================================= */
        /* 3. GLOBAL & UTILITIES           */
        /* ========================================= */

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            transition: background-color 0.4s, color 0.4s;
            overflow: hidden;
        }
        
        button, input, textarea {
            font-family: inherit;
        }

        /* Utility classes */
        .flex-center {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .no-select {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* ========================================= */
        /* 4. MAIN LAYOUT               */
        /* ========================================= */

        .container {
            width: 100%;
            max-width: 600px;
            height: 100vh;
            max-height: 900px;
            background-color: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-heavy);
            transition: background-color 0.4s;
            overflow: hidden;
            position: relative;
        }

        /* ========================================= */
        /* 5. HEADER                  */
        /* ========================================= */

        header {
            padding: 24px;
            text-align: center;
            position: relative;
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.4s;
            z-index: 10;
        }

        .header-buttons {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .header-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.2em;
            cursor: pointer;
            transition: color 0.3s, transform 0.2s;
        }

        .header-btn:hover {
            color: var(--accent-color);
            transform: scale(1.1);
        }

        header h1 {
            margin: 0;
            font-size: 1.8em;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            font-family: 'Balsamiq Sans', cursive;
        }

        .profile-pic {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 0 0 3px var(--accent-color);
            transition: box-shadow 0.4s;
        }

        .sub-header {
            font-size: 0.9em;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .sub-header a {
            color: var(--accent-color);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.4s;
        }

        /* ========================================= */
        /* 6. CHAT MESSAGES               */
        /* ========================================= */

        #main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
            scrollbar-width: thin;
            scrollbar-color: #a0a0a0 var(--bg-secondary);
            scroll-behavior: smooth;
        }

        #main-content::-webkit-scrollbar {
            width: 8px;
        }

        #main-content::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        #main-content::-webkit-scrollbar-thumb {
            background: #a0a0a0;
            border-radius: 4px;
        }

        #main-content::-webkit-scrollbar-thumb:hover {
            background: #888;
        }

        .messages-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            max-width: 85%;
            animation: fadeIn 0.4s ease-in-out;
            position: relative;
        }

        .message.temp {
            opacity: 0.7;
        }

        .message .timestamp {
            position: absolute;
            bottom: -18px;
            font-size: 0.7em;
            color: var(--text-muted);
            white-space: nowrap;
        }

        .user-message .timestamp {
            right: 0;
        }

        .bot-message .timestamp {
            left: 50px; /* Avatar width + gap */
        }
        
        /* Chat Rating Display */
        .rating-message {
            align-self: flex-start;
            background-color: var(--input-bg);
            padding: 15px;
            border-radius: var(--border-radius-md);
            margin-bottom: 20px;
            animation: slideInFromTop 0.5s ease;
        }
        
        .rating-message p {
            margin: 0 0 10px;
            font-weight: 600;
        }

        .rating-message .display-stars {
            color: var(--warning-color);
            font-size: 1.2em;
        }

        .message-content {
            padding: 14px 18px;
            border-radius: var(--border-radius-md);
            word-wrap: break-word;
            line-height: 1.6;
            box-shadow: var(--shadow-light);
            transition: background-color 0.4s, color 0.4s;
        }

        .user-message {
            align-self: flex-end;
            margin-left: auto;
        }

        .user-message .message-content {
            background-color: var(--message-bg-user);
            color: var(--message-text-user);
            border-bottom-right-radius: var(--border-radius-sm);
        }

        .bot-message .message-content {
            background-color: var(--message-bg-bot);
            color: var(--message-text-bot);
            border-bottom-left-radius: var(--border-radius-sm);
        }

        .bot-message .avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
        }
        
        .bot-message .message-content pre {
            white-space: pre-wrap;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
            padding: 10px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: var(--border-radius-sm);
            overflow-x: auto;
            position: relative;
            margin: 10px 0;
            line-height: 1.4;
        }

        .dark-mode .bot-message .message-content pre {
            background: rgba(255, 255, 255, 0.05);
        }

        .copy-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(0, 0, 0, 0.3);
            color: #fff;
            border: none;
            padding: 5px 8px;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 0.8em;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .bot-message .message-content pre:hover .copy-btn {
            opacity: 1;
        }

        .typing-indicator {
            align-self: flex-start;
            position: relative;
            padding-left: 50px;
            animation: none;
        }

        .typing-indicator .message-content {
            background-color: var(--message-bg-bot);
            padding: 10px 15px;
            border-radius: 20px;
            line-height: 1;
            display: flex;
            align-items: center;
        }

        .typing-indicator .message-content span {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: var(--text-color);
            border-radius: 50%;
            margin: 0 2px;
            animation: pulse 1.4s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .typing-indicator .message-content span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-indicator .message-content span:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        .video-container {
            margin-top: 10px;
            display: block;
        }

        .video-container video {
            width: 100%;
            border-radius: 12px;
            background: #000;
        }

        .download-guide {
            margin-top: 10px;
            font-size: 0.85em;
            color: var(--text-muted);
            background: var(--border-color);
            padding: 10px;
            border-radius: 8px;
            transition: background-color 0.4s;
        }
        
        .dark-mode .download-guide {
             color: #ccc;
             background: #3a3a3a;
        }
        
        /* ========================================= */
        /* 7. INPUT AREA (Fixed & Responsive)  */
        /* ========================================= */
        #inputArea {
            display: grid;
            grid-template-columns: min-content 1fr min-content;
            gap: 8px;
            align-items: center;
            padding: 10px;
            border-top: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
        }

        #prompt {
            width: 100%;
            min-height: 40px;
            max-height: 120px; /* Batasi tinggi input */
            padding: 10px 18px;
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            font-size: 0.95em;
            resize: none; /* Nonaktifkan resize manual */
            line-height: 1.4;
            transition: border-color 0.25s, background-color 0.25s, box-shadow 0.25s;
        }

        #prompt:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(93, 93, 255, 0.15);
        }

        .input-buttons {
            display: flex;
            gap: 6px;
        }

        .action-btn {
            width: 40px;
            height: 40px;
            background-color: var(--input-bg);
            color: var(--text-muted);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.25s, color 0.25s, transform 0.2s;
        }

        .action-btn:hover {
            color: var(--accent-color);
            background-color: var(--bg-tertiary);
            transform: translateY(-2px);
        }

        #sendBtn {
            min-width: 80px; /* Lebar tombol kirim */
            height: 40px;
            padding: 0 16px;
            background-color: var(--accent-color);
            color: #fff;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s;
        }

        #sendBtn:hover {
            background-color: var(--accent-hover);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        #sendBtn:active {
            transform: scale(0.95);
        }


        /* ========================================= */
        /* 8. MODAL & FEEDBACK UI           */
        /* ========================================= */

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 100;
        }

        .modal.active {
            visibility: visible;
            opacity: 1;
        }

        .modal-content {
            background-color: var(--bg-secondary);
            padding: 30px;
            border-radius: var(--border-radius-md);
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: translateY(20px);
            transition: transform 0.3s ease-out;
        }
        
        .modal.active .modal-content {
            transform: translateY(0);
        }

        .modal-content h3 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .rating-stars {
            text-align: center;
            font-size: 2em;
            color: #ccc;
            cursor: pointer;
            margin-bottom: 20px;
            transition: color 0.3s;
        }

        .rating-stars .star {
            transition: color 0.2s, transform 0.2s;
            display: inline-block;
        }
        
        .rating-stars .star:hover {
            transform: scale(1.1);
            color: #ffc107;
        }

        .rating-stars .star.rated {
            color: #ffc107;
        }
        
        #commentInput {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background-color: var(--input-bg);
            color: var(--text-color);
            resize: vertical;
            font-family: 'Poppins', sans-serif;
            margin-bottom: 15px;
            min-height: 80px;
        }

        #submitFeedbackBtn {
            width: 100%;
            padding: 14px;
            background-color: var(--accent-color);
            color: #fff;
            border: none;
            border-radius: var(--border-radius-sm);
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }
        
        #submitFeedbackBtn:hover {
            background-color: var(--accent-hover);
        }

        /* ========================================= */
        /* 9. FOOTER                    */
        /* ========================================= */

        footer {
            padding: 12px;
            text-align: center;
            font-size: 0.8em;
            color: var(--text-muted);
            border-top: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            transition: background-color 0.4s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        
        footer a {
            color: var(--accent-color);
            text-decoration: none;
            transition: color 0.3s;
        }

        /* ========================================= */
        /* 10. TOAST NOTIFICATION              */
        /* ========================================= */

        #toast-notification {
            visibility: hidden;
            min-width: 250px;
            background-color: var(--text-color);
            color: var(--bg-primary);
            text-align: center;
            border-radius: var(--border-radius-sm);
            padding: 16px;
            position: fixed;
            z-index: 101;
            bottom: 30px;
            font-size: 0.9em;
            transform: translateX(-50%);
            left: 50%;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s, background-color 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        #toast-notification.show {
            visibility: visible;
            opacity: 1;
        }

        /* ========================================= */
        /* 11. RESPONSIVE DESIGN               */
        /* ========================================= */

        @media (max-width: 768px) {
            body {
                padding: 0;
            }
            .container {
                width: 100%;
                height: 100vh;
                border-radius: 0;
                box-shadow: none;
            }
            
            header {
                padding: 16px;
            }
            
            header h1 {
                font-size: 1.4em;
            }

            .profile-pic {
                width: 40px;
                height: 40px;
            }

            .header-buttons {
                top: 10px;
                right: 10px;
            }
            
            #inputArea {
                grid-template-columns: min-content 1fr min-content;
                padding: 8px;
                gap: 6px;
            }

            #prompt {
                padding: 8px 16px;
                font-size: 0.9em;
            }

            .action-btn {
                width: 38px;
                height: 38px;
            }

            #sendBtn {
                height: 38px;
                min-width: 70px;
            }
            
            .modal-content {
                padding: 20px;
            }
        }

        /* ========================================= */
        /* 12. KEYFRAME ANIMATIONS            */
        /* ========================================= */

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInFromTop {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(0.8); opacity: 0.5; }
            50% { transform: scale(1); opacity: 1; }
        }
        
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-buttons">
                <button id="themeToggleBtn" class="header-btn" title="Toggle Dark/Light Mode">
                    <i class="fas fa-moon"></i>
                </button>
                <button id="rateBtn" class="header-btn" title="Beri Ulasan">
                    <i class="fas fa-star"></i>
                </button>
                <a id="bugReportBtn" href="https://wa.me/6281249703469?text=Halo%20Alif,%20saya%20menemukan%20bug%20di%20website%20AI%20Anda.%20Detail%20bug:%20" class="header-btn" title="Laporkan Bug">
                    <i class="fas fa-bug"></i>
                </a>
                <button id="clearChatBtn" class="header-btn" title="Hapus Chat">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <h1>
                <img src="https://img1.pixhost.to/images/8232/635013559_media.jpg" alt="AI Profile" class="profile-pic"> 
                Alip AI
            </h1>
            <p class="sub-header">Cerdas & Premium oleh <a href="https://instagram.com/alifalfrl__" target="_blank">@alifalfrl__</a></p>
        </header>
        
        <main id="main-content">
            <div id="messages" class="messages-list"></div>
        </main>
        
        <div id="inputArea">
            <button id="voiceInputBtn" class="action-btn" title="Input Suara">
                <i class="fas fa-microphone"></i>
            </button>
            <textarea id="prompt" placeholder="Ketik pesan" rows="1"></textarea>
            <button id="sendBtn">Kirim</button>
        </div>
        
        <footer>©alipclutch - AI Asisten 2025</footer>
    </div>
    
    <div id="ratingModal" class="modal">
        <div class="modal-content">
            <h3>Beri Kami Rating!</h3>
            <div class="rating-stars" id="ratingStars">
                <span class="star" data-value="1"><i class="fa-solid fa-star"></i></span>
                <span class="star" data-value="2"><i class="fa-solid fa-star"></i></span>
                <span class="star" data-value="3"><i class="fa-solid fa-star"></i></span>
                <span class="star" data-value="4"><i class="fa-solid fa-star"></i></span>
                <span class="star" data-value="5"><i class="fa-solid fa-star"></i></span>
            </div>
            <textarea id="commentInput" placeholder="Tulis komentar Anda tentang website ini..."></textarea>
            <button id="submitFeedbackBtn">Kirim Ulasan</button>
        </div>
    </div>

    <div id="toast-notification"></div>

    <script>
        // DOM Element References
        const messagesEl = document.getElementById('messages');
        const promptInput = document.getElementById('prompt');
        const sendBtn = document.getElementById('sendBtn');
        const voiceInputBtn = document.getElementById('voiceInputBtn');
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        const rateBtn = document.getElementById('rateBtn');
        const clearChatBtn = document.getElementById('clearChatBtn');
        const ratingModal = document.getElementById('ratingModal');
        const ratingStars = document.getElementById('ratingStars');
        const commentInput = document.getElementById('commentInput');
        const submitFeedbackBtn = document.getElementById('submitFeedbackBtn');
        const toastNotification = document.getElementById('toast-notification');
        
        // Constants & Global State
        const BOT_AVATAR_URL = 'https://img1.pixhost.to/images/8232/635013559_media.jpg';
        const SYSTEM_PROMPT = `
            Kamu adalah Alip AI, asisten pintar yang dibuat oleh Alif Alfarel. Jawablah dengan sopan, jelas, 
            dan langsung ke inti, dengan gaya profesional namun tetap ramah. Selain bisa diajak ngobrol dan 
            curhat, kamu juga mampu mendeteksi link dari TikTok, Instagram, atau Pinterest untuk membantu 
            mengunduh video. Jika link tidak didukung atau proses download gagal, jawab dengan penjelasan 
            singkat dan sopan.
            
            Sebagai Alip AI, kamu tidak diperkenankan untuk memberikan jawaban yang bersifat kontroversial, 
            menghasut, atau ilegal. Prioritaskan keamanan dan privasi pengguna.
            
            Aturan Tambahan:
            - Selalu tambahkan emoji yang relevan di setiap jawaban.
            - Gunakan format markdown untuk kode atau daftar.
            - Jaga nada bicara yang positif dan membantu.
        `;
        const API_URL_1 = 'https://api.siputzx.my.id/api/ai/bard';
        const API_URL_2 = 'https://api.siputzx.my.id/api/ai/metaai';
        const DOWNLOAD_API_KEY = '1dda0d29d3mshc5f2aacec619c44p16f219jsn99a62a516f98';
        const DOWNLOAD_API_HOST = 'auto-download-all-in-one.p.rapidapi.com';
        
        let isTyping = false;
        let typingIndicator = null;
        let currentTheme = localStorage.getItem('theme') || 'light';
        let currentRating = 0;
        let userFeedback = JSON.parse(localStorage.getItem('userFeedback')) || {};
        let conversationHistory = []; // Untuk menyimpan riwayat chat

        // =========================================
        //          CORE CHAT FUNCTIONALITY
        // =========================================

        /**
         * Adds a message to the chat interface.
         * @param {string} content - The message content (HTML or plain text).
         * @param {string} sender - 'user' or 'bot'.
         * @param {boolean} isVideo - True if the message contains a video element.
         * @param {boolean} isTemp - True for temporary messages (like "typing...").
         */
        function addMessage(content, sender, isVideo = false, isTemp = false) {
            const messageContainer = document.createElement('div');
            messageContainer.classList.add('message', `${sender}-message`);
            if (isTemp) messageContainer.classList.add('temp');

            if (sender === 'bot') {
                const botAvatar = document.createElement('img');
                botAvatar.src = BOT_AVATAR_URL;
                botAvatar.alt = 'AI Avatar';
                botAvatar.classList.add('avatar');
                messageContainer.appendChild(botAvatar);
            }

            const messageContent = document.createElement('div');
            messageContent.classList.add('message-content');
            
            // Check for code blocks to add copy button
            if (content.includes('```')) {
                const parts = content.split('```');
                let formattedHtml = '';
                for (let i = 0; i < parts.length; i++) {
                    if (i % 2 === 1) { // This part is the code block
                        formattedHtml += `<pre><button class="copy-btn" onclick="copyCode(this)">Salin</button>${parts[i].trim()}</pre>`;
                    } else {
                        formattedHtml += parts[i].replace(/\n/g, '<br>');
                    }
                }
                messageContent.innerHTML = formattedHtml;
            } else {
                // For regular text, replace newlines with <br>
                messageContent.innerHTML = isVideo ? content : content.replace(/\n/g, '<br>');
            }
            
            messageContainer.appendChild(messageContent);

            const timestamp = document.createElement('span');
            timestamp.classList.add('timestamp');
            timestamp.textContent = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            messageContainer.appendChild(timestamp);

            messagesEl.appendChild(messageContainer);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        /**
         * Displays the "typing" indicator.
         */
        function showTypingIndicator() {
            if (isTyping) return;
            isTyping = true;
            typingIndicator = document.createElement('div');
            typingIndicator.classList.add('message', 'bot-message', 'typing-indicator');
            typingIndicator.innerHTML = `
                <img src="${BOT_AVATAR_URL}" alt="AI Avatar" class="avatar"> 
                <div class="message-content">
                    <span></span><span></span><span></span>
                </div>
            `;
            messagesEl.appendChild(typingIndicator);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        /**
         * Hides the "typing" indicator.
         */
        function hideTypingIndicator() {
            if (!isTyping) return;
            isTyping = false;
            if (typingIndicator) {
                typingIndicator.remove();
                typingIndicator = null;
            }
        }
        
        /**
         * Core function to handle user input.
         */
        async function handleInput() {
            const query = promptInput.value.trim();
            if (!query) {
                showToast('Masukkan pesan atau link terlebih dahulu!', 'error');
                return;
            }

            // Add user message to UI and history
            addMessage(query, 'user');
            conversationHistory.push({ sender: 'user', text: query });
            promptInput.value = '';

            const urlRegex = /^(http|https):\/\/[^ "]+$/;

            if (urlRegex.test(query)) {
                await handleVideoDownload(query);
            } else {
                await handleAIResponse(query);
            }
            // Reset textarea height after sending
            promptInput.style.height = 'auto';
        }

        /**
         * Handles the video download process.
         * @param {string} link - The video link provided by the user.
         */
        async function handleVideoDownload(link) {
            addMessage('Saya mendeteksi ini adalah link video. Sebentar, saya akan coba unduh untuk Anda... ⏳', 'bot');
            try {
                const response = await fetch('https://auto-download-all-in-one.p.rapidapi.com/v1/social/autolink', {
                    method: 'POST',
                    headers: {
                        'accept-encoding': 'gzip',
                        'content-type': 'application/json; charset=utf-8',
                        'x-rapidapi-host': DOWNLOAD_API_HOST,
                        'x-rapidapi-key': DOWNLOAD_API_KEY
                    },
                    body: JSON.stringify({ url: link })
                });

                const data = await response.json();

                if (!data || !data.medias || data.medias.length === 0) {
                    addMessage('❌ Gagal mendapatkan video. Pastikan link publik dan coba lagi.', 'bot');
                    return;
                }

                const media = data.medias[0];
                const videoHtml = `
                    <div>
                        <p style="font-size: 0.9em; margin-bottom: 10px; color: var(--text-color);">Berhasil! Video siap diputar:</p>
                        <div class="video-container">
                            <video controls>
                                <source src="${media.url}" type="video/mp4">
                                Browser Anda tidak mendukung tag video.
                            </video>
                        </div>
                        <div class="download-guide">
                            <strong>Cara Download:</strong> Klik ikon titik tiga (⋮) di video lalu pilih Download.
                        </div>
                    </div>
                `;
                addMessage(videoHtml, 'bot', true);
                conversationHistory.push({ sender: 'bot', text: 'Video berhasil diunduh.' });
            } catch (err) {
                console.error(err);
                addMessage('❌ Terjadi kesalahan saat mengunduh. Silakan coba lagi nanti.', 'bot');
            }
        }

        /**
         * Handles the AI conversation response.
         * @param {string} query - The user's text query.
         */
        async function handleAIResponse(query) {
            showTypingIndicator();
            const fullPrompt = `${SYSTEM_PROMPT}\n\nRiwayat Percakapan:\n${conversationHistory.map(m => `${m.sender}: ${m.text}`).join('\n')}\n\nPesan Terbaru: ${query}`;
            
            let replyText;
            try {
                // Attempt with primary API
                const res1 = await fetch(`${API_URL_1}?query=${encodeURIComponent(fullPrompt)}`, { headers: { 'accept': '*/*' } });
                if (res1.ok) {
                    const data = await res1.json();
                    replyText = data.data || 'Maaf, ada masalah dengan respons API pertama.';
                } else {
                    console.warn('Primary API failed, trying backup...');
                    // Attempt with secondary API on failure
                    const res2 = await fetch(`${API_URL_2}?query=${encodeURIComponent(fullPrompt)}`, { headers: { 'accept': '*/*' } });
                    if (res2.ok) {
                        const data = await res2.json();
                        replyText = data.result || data.data || data.output || 'Maaf, ada masalah dengan respons API cadangan.';
                    } else {
                        throw new Error(`Failed to contact both APIs: Status ${res2.status}`);
                    }
                }
            } catch (e) {
                console.error('AI response error:', e);
                replyText = `❌ Terjadi kesalahan saat memproses permintaan. Silakan coba lagi.`;
            }

            hideTypingIndicator();
            replyText = replyText.replace(/\n+/g, '\n').trim();
            addMessage(replyText, 'bot');
            conversationHistory.push({ sender: 'bot', text: replyText });
        }

        // =========================================
        //          UTILITY FUNCTIONS
        // =========================================

        /**
         * Displays a temporary toast notification.
         * @param {string} message - The message to display.
         * @param {string} type - 'success', 'error', or 'info'.
         */
        function showToast(message, type = 'success') {
            toastNotification.textContent = message;
            toastNotification.style.backgroundColor = getComputedStyle(document.documentElement)
                                                     .getPropertyValue(`--${type}-color`);
            toastNotification.classList.add('show');
            setTimeout(() => {
                toastNotification.classList.remove('show');
            }, 3000);
        }

        /**
         * Copies a code block to the clipboard.
         * @param {HTMLElement} button - The button element that was clicked.
         */
        window.copyCode = (button) => {
            const preElement = button.parentElement;
            const code = preElement.textContent.replace('Salin', '').trim();
            navigator.clipboard.writeText(code).then(() => {
                showToast('Kode berhasil disalin!', 'success');
            }).catch(err => {
                showToast('Gagal menyalin kode.', 'error');
                console.error('Failed to copy text: ', err);
            });
        };
        
        /**
         * Displays the user's saved rating in the chat history.
         */
        function displayRatingOnChat(rating, comment) {
            const ratingHtml = `
                <div class="rating-message">
                    <p>⭐ Ulasan Anda tersimpan!</p>
                    <div class="display-stars">${'⭐'.repeat(rating)}${'☆'.repeat(5 - rating)}</div>
                    ${comment ? `<p style="font-size:0.9em; margin: 10px 0 0; color: var(--text-muted);">${comment}</p>` : ''}
                </div>
            `;
            const ratingContainer = document.createElement('div');
            ratingContainer.innerHTML = ratingHtml;
            messagesEl.appendChild(ratingContainer.firstChild);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        // =========================================
        //          EVENT LISTENERS & SETUP
        // =========================================

        /**
         * Toggles the light/dark theme.
         */
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            themeToggleBtn.innerHTML = isDarkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        }
        
        /**
         * Applies the initial theme from localStorage.
         */
        function applyInitialTheme() {
            if (currentTheme === 'dark') {
                document.body.classList.add('dark-mode');
                themeToggleBtn.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                themeToggleBtn.innerHTML = '<i class="fas fa-moon"></i>';
            }
        }

        /**
         * Initializes the voice recognition feature.
         */
        function initializeVoiceInput() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                console.warn('Speech Recognition not supported in this browser.');
                voiceInputBtn.style.display = 'none'; // Hide button if not supported
                return;
            }

            const recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'id-ID';

            voiceInputBtn.addEventListener('click', () => {
                try {
                    promptInput.placeholder = 'Mendengarkan... 🎙️';
                    recognition.start();
                } catch (e) {
                    console.error('Voice recognition error:', e);
                    showToast('Gagal memulai input suara. Pastikan Anda memberikan izin.', 'error');
                }
            });

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                promptInput.value = transcript;
                promptInput.placeholder = 'Ketik pesan atau tempel link video...';
                handleInput();
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                promptInput.placeholder = 'Ketik pesan atau tempel link video...';
                showToast(`Input suara gagal: ${event.error}`, 'error');
            };

            recognition.onend = () => {
                promptInput.placeholder = 'Ketik pesan atau tempel link video...';
            };
        }

        // --- Event Listeners ---
        sendBtn.addEventListener('click', handleInput);
        promptInput.addEventListener('keypress', e => {
            if (e.key === 'Enter' && !e.shiftKey) { // Kirim pesan saat Enter, tapi tetap bisa baris baru pakai Shift+Enter
                e.preventDefault(); 
                handleInput();
            }
        });

        // Auto-resize textarea
        promptInput.addEventListener('input', () => {
            promptInput.style.height = 'auto';
            promptInput.style.height = promptInput.scrollHeight + 'px';
        });

        themeToggleBtn.addEventListener('click', toggleTheme);
        clearChatBtn.addEventListener('click', () => {
            messagesEl.innerHTML = '';
            conversationHistory = [];
            addMessage('Chat telah dihapus. Ada yang bisa saya bantu lagi? 🤔', 'bot');
            showToast('Riwayat chat berhasil dihapus.');
        });
        
        // Modal Event Listeners
        rateBtn.addEventListener('click', () => {
            ratingModal.classList.add('active');
            
            const savedFeedback = JSON.parse(localStorage.getItem('userFeedback')) || {};
            currentRating = savedFeedback.rating || 0;
            commentInput.value = savedFeedback.comment || '';
            
            document.querySelectorAll('#ratingStars .star').forEach((s, index) => {
                s.classList.toggle('rated', index < currentRating);
            });
        });
        ratingStars.addEventListener('click', (e) => {
            const star = e.target.closest('.star');
            if (star) {
                currentRating = parseInt(star.dataset.value);
                document.querySelectorAll('#ratingStars .star').forEach((s, index) => {
                    s.classList.toggle('rated', index < currentRating);
                });
            }
        });
        submitFeedbackBtn.addEventListener('click', () => {
            const comment = commentInput.value.trim();
            if (currentRating === 0) {
                showToast('Silakan berikan rating bintang terlebih dahulu.', 'error');
                return;
            }

            const feedbackData = { rating: currentRating, comment: comment };
            localStorage.setItem('userFeedback', JSON.stringify(feedbackData));
            
            displayRatingOnChat(currentRating, comment);
            showToast('Terima kasih atas ulasan Anda!');
            
            ratingModal.classList.remove('active');
            commentInput.value = '';
            currentRating = 0;
            document.querySelectorAll('#ratingStars .star').forEach(s => s.classList.remove('rated'));
        });
        ratingModal.addEventListener('click', (e) => {
            if (e.target.id === 'ratingModal') {
                ratingModal.classList.remove('active');
            }
        });
        
        // Initial Message & Setup
        window.onload = () => {
            applyInitialTheme();
            addMessage('Halo! Saya Alip AI, AI yang bisa diajak ngobrol dan juga bisa mengunduh video dari berbagai platform. Silakan ketik pesan atau tempel link video yang ingin Anda unduh. 😊', 'bot');
            
            if (userFeedback.rating) {
                displayRatingOnChat(userFeedback.rating, userFeedback.comment);
            }

            initializeVoiceInput();
        };
    </script>
</body>
</html>
