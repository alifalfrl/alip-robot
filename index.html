<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Alip AI - Teman Ngobrol Terbaik</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.6/dist/purify.min.js"></script>
<style>
  /* --- Variables --- */
  :root {
    --primary-color: #6C63FF; /* Ungu cerah */
    --primary-dark-color: #574BDB; /* Ungu gelap */
    --accent-color: #00bcd4; /* Cyan - untuk highlight, link, dll */
    --background-color: #f8faff; /* Latar belakang aplikasi */
    --chat-background: #ffffff; /* Latar belakang area chat */
    --user-message-bg: #e3f2fd; /* Biru muda */
    --bot-message-bg: #f3e5f5; /* Ungu muda */
    --text-color: #2c3e50; /* Teks utama (dark blue-grey) */
    --text-light-color: #7f8c8d; /* Teks sekunder (grey) */
    --border-color: #e0e0e0; /* Warna border */
    --input-border-focus: var(--primary-color);
    --shadow-light: rgba(0, 0, 0, 0.08);
    --shadow-medium: rgba(0, 0, 0, 0.15);
    --header-shadow: rgba(0, 0, 0, 0.25);
    --border-radius-large: 20px;
    --border-radius-pill: 40px;
    --section-bg-light: #ffffff;
    --section-bg-dark: #f0f2f5;
    --success-color: #28a745;
    --success-light-bg: #d4edda;
    --error-color: #D32F2F;
    --error-light-bg: #FFEBEE;
    --warning-color: #ffc107;
    --warning-light-bg: #fff3cd;


    /* Dark Mode Variables */
    --dm-background-color: #1a1a2e;
    --dm-chat-background: #16213e;
    --dm-user-message-bg: #4a569d;
    --dm-bot-message-bg: #533483;
    --dm-text-color: #e0e0e0;
    --dm-text-light-color: #a0a0a0;
    --dm-border-color: #3e3e50;
    --dm-input-bg: #2b2b3f;
    --dm-shadow-light: rgba(0, 0, 0, 0.2);
    --dm-shadow-medium: rgba(0, 0, 0, 0.4);
    --dm-header-shadow: rgba(0, 0, 0, 0.6);
    --dm-skeleton-color: #3b3b5b;
    --dm-section-bg-light: #2c2c4a;
    --dm-section-bg-dark: #1e1e35;
    --dm-success-light-bg: #1e3a24;
    --dm-error-light-bg: #3f1717;
    --dm-warning-light-bg: #3f3111;

    /* Custom Scrollbar */
    --scrollbar-track-bg: var(--background-color);
    --scrollbar-thumb-bg: #ccc;
    --scrollbar-thumb-hover-bg: #aaa;
    --dm-scrollbar-track-bg: var(--dm-background-color);
    --dm-scrollbar-thumb-bg: #555;
    --dm-scrollbar-thumb-hover-bg: #777;
  }

  /* --- Scrollbar Styling --- */
  ::-webkit-scrollbar {
    width: 12px;
  }

  ::-webkit-scrollbar-track {
    background: var(--scrollbar-track-bg);
    border-radius: 10px;
  }

  ::-webkit-scrollbar-thumb {
    background: var(--scrollbar-thumb-bg);
    border-radius: 10px;
    border: 3px solid var(--scrollbar-track-bg);
  }

  ::-webkit-scrollbar-thumb:hover {
    background: var(--scrollbar-thumb-hover-bg);
  }

  body.dark-mode ::-webkit-scrollbar-track {
    background: var(--dm-scrollbar-track-bg);
  }

  body.dark-mode ::-webkit-scrollbar-thumb {
    background: var(--dm-scrollbar-thumb-bg);
    border-color: var(--dm-scrollbar-track-bg);
  }

  body.dark-mode ::-webkit-scrollbar-thumb:hover {
    background: var(--dm-scrollbar-thumb-hover-bg);
  }

  /* --- Keyframes & Animations --- */
  @keyframes gradientAnimation {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  @keyframes bounceIn {
    0% { transform: scale(0.5); opacity: 0; }
    70% { transform: scale(1.1); opacity: 1; }
    100% { transform: scale(1); }
  }

  @keyframes slideInUp {
    from { transform: translateY(50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  @keyframes messagePopIn {
    0% { opacity: 0; transform: translateY(10px) scale(0.9); }
    100% { opacity: 1; transform: translateY(0) scale(1); }
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    20%, 60% { transform: translateX(-8px); }
    40%, 80% { transform: translateX(8px); }
  }

  @keyframes typing-fade {
    0%, 80%, 100% { opacity: 0; }
    40% { opacity: 1; }
  }

  @keyframes pulse {
    0% { opacity: 0.4; }
    50% { opacity: 1; }
    100% { opacity: 0.4; }
  }

  @keyframes rotateIn {
    from { transform: rotate(-180deg) scale(0.2); opacity: 0; }
    to { transform: rotate(0deg) scale(1); opacity: 1; }
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes slideUpAndFadeIn {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  /* --- Base Styles --- */
  body {
    margin: 0;
    padding: 0;
    font-family: 'Inter', sans-serif;
    background-color: var(--background-color);
    color: var(--text-color);
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    transition: background-color 0.4s ease, color 0.4s ease;
  }

  body.dark-mode {
    background-color: var(--dm-background-color);
    color: var(--dm-text-color);
  }

  /* --- Header --- */
  header {
    background: linear-gradient(270deg, var(--primary-color), var(--primary-dark-color));
    background-size: 200% 200%;
    animation: gradientAnimation 10s ease infinite;
    padding: 1.8rem 1rem;
    font-family: 'Poppins', sans-serif;
    font-size: 2.2rem;
    font-weight: 700;
    text-align: center;
    color: white;
    box-shadow: 0 8px 25px var(--header-shadow);
    z-index: 100;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    position: sticky;
    top: 0;
    width: 100%;
    box-sizing: border-box;
    overflow: hidden;
    transition: background 0.4s ease, box-shadow 0.4s ease;
  }

  header i {
    font-size: 2.4rem;
    animation: bounceIn 0.8s ease-out;
  }

  .header-actions {
    position: absolute;
    right: 1.5rem;
    display: flex;
    gap: 1rem;
  }

  .header-btn {
    background-color: rgba(255, 255, 255, 0.25);
    border: none;
    border-radius: 50%;
    color: white;
    width: 45px;
    height: 45px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.15s ease, box-shadow 0.2s ease;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
  }

  .header-btn:hover {
    background-color: rgba(255, 255, 255, 0.4);
    transform: translateY(-4px) scale(1.05);
    box-shadow: 0 6px 18px rgba(0,0,0,0.35);
  }

  .header-btn:active {
    transform: translateY(0) scale(0.98);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }

  /* --- Chat Section --- */
  #chat-section {
    padding: 0;
    background-color: var(--background-color);
    flex: 1;
    display: flex;
    flex-direction: column;
    height: calc(100vh - var(--header-height) - var(--form-height)); /* Adjusted by JS */
    min-height: 500px;
  }
  body.dark-mode #chat-section {
    background-color: var(--dm-background-color);
  }

  #chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 2rem;
    overflow-y: auto;
    scroll-behavior: smooth;
    background: var(--chat-background);
    border-radius: var(--border-radius-large);
    margin: 2rem;
    box-shadow: 0 10px 35px var(--shadow-medium);
    transition: background 0.4s ease, box-shadow 0.4s ease;
    animation: slideInUp 0.8s ease-out forwards;
  }

  body.dark-mode #chat-container {
    background: var(--dm-chat-background);
    box-shadow: 0 10px 35px var(--dm-shadow-medium);
  }

  .message-wrapper {
    display: flex;
    margin-bottom: 1.8rem;
    align-items: flex-start;
    animation: messagePopIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    opacity: 0;
    transform: scale(0.9);
  }

  .message-wrapper.user {
    justify-content: flex-end;
  }

  .message-wrapper.bot {
    justify-content: flex-start;
  }

  .avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(45deg, var(--primary-color), var(--primary-dark-color));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
    font-weight: 600;
    color: white;
    flex-shrink: 0;
    box-shadow: 0 4px 10px var(--shadow-light);
    overflow: hidden;
    border: 3px solid white;
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, border-color 0.4s ease, background 0.4s ease;
  }

  body.dark-mode .avatar {
    border: 3px solid var(--dm-chat-background);
  }

  .avatar:hover {
    transform: scale(1.15) rotate(5deg);
    box-shadow: 0 6px 15px rgba(0,0,0,0.25);
  }

  .avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .message-wrapper.bot .avatar {
    margin-right: 20px;
  }

  .message-wrapper.user .avatar {
    order: 2;
    margin-left: 20px;
  }

  .message {
    max-width: 70%;
    padding: 1.3rem 2rem;
    border-radius: var(--border-radius-large);
    line-height: 1.8;
    white-space: pre-wrap;
    box-shadow: 0 4px 15px var(--shadow-light);
    word-wrap: break-word;
    font-size: 1.08rem;
    transition: all 0.3s ease-out, background 0.4s ease, color 0.4s ease, transform 0.2s ease;
    position: relative;
    word-break: break-word;
  }

  .message.bot:hover {
    transform: translateY(-5px) scale(1.02);
    box-shadow: 0 8px 20px var(--shadow-medium);
  }

  .user .message {
    background: var(--user-message-bg);
    color: var(--text-color);
    border-top-right-radius: var(--border-radius-large);
    border-bottom-right-radius: 8px;
    position: relative;
    right: -8px;
  }
  body.dark-mode .user .message {
    background: var(--dm-user-message-bg);
    color: var(--dm-text-color);
  }

  .bot .message {
    background: var(--bot-message-bg);
    color: var(--text-color);
    border-top-left-radius: var(--border-radius-large);
    border-bottom-left-radius: 8px;
    position: relative;
    left: -8px;
  }
  body.dark-mode .bot .message {
    background: var(--dm-bot-message-bg);
    color: var(--dm-text-color);
  }

  /* Copy button for bot messages */
  .bot .message .copy-btn {
    position: absolute;
    bottom: 8px;
    right: 8px;
    background-color: rgba(0, 0, 0, 0.15);
    color: var(--text-light-color);
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.2s ease, background-color 0.2s ease, transform 0.1s ease;
  }
  body.dark-mode .bot .message .copy-btn {
    background-color: rgba(255, 255, 255, 0.15);
    color: var(--dm-text-light-color);
  }

  .bot .message:hover .copy-btn,
  .bot .message .copy-btn.copied {
    opacity: 1;
  }

  .bot .message .copy-btn:hover {
    background-color: rgba(0, 0, 0, 0.3);
    transform: translateY(-3px);
  }
  body.dark-mode .bot .message .copy-btn:hover {
    background-color: rgba(255, 255, 255, 0.3);
  }

  .bot .message .copy-btn.copied {
    background-color: var(--success-color);
    color: white;
  }

  /* --- Form (Input Area) --- */
  form {
    display: flex;
    padding: 2rem;
    background-color: var(--chat-background);
    border-top: 1px solid var(--border-color);
    box-shadow: 0 -8px 25px var(--shadow-medium);
    gap: 1.2rem;
    align-items: flex-end;
    position: sticky;
    bottom: 0;
    width: 100%;
    box-sizing: border-box;
    z-index: 10;
    flex-shrink: 0;
    transition: background-color 0.4s ease, border-top-color 0.4s ease, box-shadow 0.4s ease;
  }
  body.dark-mode form {
    background-color: var(--dm-chat-background);
    border-top: 1px solid var(--dm-border-color);
    box-shadow: 0 -8px 25px var(--dm-shadow-medium);
  }

  #input {
    flex: 1;
    padding: 1.4rem 2rem;
    font-size: 1.15rem;
    border-radius: var(--border-radius-pill);
    border: 2px solid var(--border-color);
    outline: none;
    transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease, color 0.3s ease;
    background-color: #ffffff;
    color: var(--text-color);
    box-shadow: inset 0 2px 5px var(--shadow-light);
    resize: none;
    min-height: 60px;
    max-height: 250px;
    overflow-y: auto;
    line-height: 1.6;
  }
  body.dark-mode #input {
    background-color: var(--dm-input-bg);
    border: 2px solid var(--dm-border-color);
    color: var(--dm-text-color);
    box-shadow: inset 0 2px 5px var(--dm-shadow-light);
  }

  #input::placeholder {
    color: var(--text-light-color);
    opacity: 0.8;
  }
  body.dark-mode #input::placeholder {
    color: var(--dm-text-light-color);
  }

  #input:focus {
    border-color: var(--input-border-focus);
    box-shadow: 0 0 0 6px rgba(108, 99, 255, 0.3);
    background-color: #fdfefe;
  }
  body.dark-mode #input:focus {
    box-shadow: 0 0 0 6px rgba(108, 99, 255, 0.5);
    background-color: var(--dm-input-bg);
  }

  .send-button {
    background: linear-gradient(to right, var(--primary-color), var(--primary-dark-color));
    border: none;
    border-radius: var(--border-radius-pill);
    color: white;
    font-weight: 600;
    font-size: 1.3rem;
    cursor: pointer;
    width: 60px;
    height: 60px;
    min-width: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.3s ease, transform 0.15s ease, box-shadow 0.3s ease;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  }

  .send-button:hover:not(:disabled) {
    background: linear-gradient(to right, var(--primary-dark-color), #4B41D8);
    transform: translateY(-5px) scale(1.05);
    box-shadow: 0 8px 22px rgba(0,0,0,0.45);
  }

  .send-button:active:not(:disabled) {
    transform: translateY(0) scale(0.98);
    box-shadow: 0 3px 10px rgba(0,0,0,0.25);
  }

  .send-button:disabled {
    background: #B0BEC5;
    cursor: not-allowed;
    opacity: 0.7;
    box-shadow: none;
  }

  .send-button .spinner {
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-top: 4px solid #fff;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    animation: spin 0.8s linear infinite;
  }

  #error {
    color: var(--error-color);
    text-align: center;
    padding: 1.5rem;
    background-color: var(--error-light-bg);
    border: 2px solid var(--error-color);
    border-radius: var(--border-radius-large);
    margin: 0 2rem 2rem 2rem;
    font-size: 1.05rem;
    font-weight: 500;
    display: none;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    flex-shrink: 0;
    transition: margin-bottom 0.3s ease, background-color 0.4s ease, color 0.4s ease;
    animation: shake 0.6s ease-in-out;
  }
  body.dark-mode #error {
    background-color: var(--dm-error-light-bg);
    border: 2px solid var(--error-color);
    color: #FFCDD2;
  }

  /* --- Typing Animation --- */
  .typing-indicator {
    display: flex;
    align-items: center;
    padding: 1.3rem 2rem;
    background: var(--bot-message-bg);
    border-radius: var(--border-radius-large);
    box-shadow: 0 4px 10px var(--shadow-light);
    max-width: fit-content;
    left: -8px;
    position: relative;
    transition: background 0.4s ease;
  }
  body.dark-mode .typing-indicator {
    background: var(--dm-bot-message-bg);
  }

  .typing-dot {
    width: 14px;
    height: 14px;
    margin: 0 5px;
    background-color: var(--text-light-color);
    border-radius: 50%;
    opacity: 0;
    animation: typing-fade 1.6s infinite ease-in-out;
    transition: background-color 0.4s ease;
  }
  body.dark-mode .typing-dot {
    background-color: var(--dm-text-light-color);
  }

  .typing-dot:nth-child(1) { animation-delay: 0s; }
  .typing-dot:nth-child(2) { animation-delay: 0.3s; }
  .typing-dot:nth-child(3) { animation-delay: 0.6s; }

  /* --- Fixed Report Bug Button (New Look) --- */
  .report-bug-btn {
    position: fixed;
    right: 2rem;
    bottom: var(--report-bug-btn-bottom-offset); /* Dynamically set by JS */
    background: linear-gradient(135deg, #FF6B6B, #EE5253); /* Warm, inviting red gradient */
    color: white;
    border: none;
    border-radius: var(--border-radius-pill);
    padding: 1rem 1.6rem;
    font-size: 1.1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.8rem;
    cursor: pointer;
    box-shadow: 0 5px 18px rgba(255, 107, 107, 0.4); /* Soft shadow with red tint */
    transition: all 0.3s ease;
    text-decoration: none;
    z-index: 99;
    opacity: 0.95;
    animation: slideUpAndFadeIn 0.6s ease-out forwards;
  }

  .report-bug-btn:hover {
    background: linear-gradient(135deg, #EE5253, #D44242);
    transform: translateY(-5px) scale(1.02);
    box-shadow: 0 8px 25px rgba(255, 107, 107, 0.6);
  }

  .report-bug-btn:active {
    transform: translateY(0) scale(0.98);
    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
  }

  .report-bug-btn i {
    font-size: 1.4rem;
  }

  /* Tooltip for Report Bug Button */
  .report-bug-btn .tooltiptext {
    visibility: hidden;
    width: 160px;
    background-color: rgba(0, 0, 0, 0.8);
    color: #fff;
    text-align: center;
    border-radius: 6px;
    padding: 8px 12px;
    position: absolute;
    z-index: 1;
    bottom: 125%; /* Position above the button */
    left: 50%;
    margin-left: -80px; /* Center the tooltip */
    opacity: 0;
    transition: opacity 0.3s;
    font-size: 0.9rem;
    white-space: nowrap;
  }

  .report-bug-btn .tooltiptext::after {
    content: "";
    position: absolute;
    top: 100%;
    left: 50%;
    margin-left: -5px;
    border-width: 5px;
    border-style: solid;
    border-color: rgba(0, 0, 0, 0.8) transparent transparent transparent;
  }

  .report-bug-btn:hover .tooltiptext {
    visibility: visible;
    opacity: 1;
  }

  /* --- Skeleton Screen --- */
  .skeleton-message {
    display: flex;
    margin-bottom: 1.8rem;
    align-items: flex-start;
  }

  .skeleton-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: var(--border-color);
    flex-shrink: 0;
    animation: pulse 1.8s infinite ease-in-out;
  }
  body.dark-mode .skeleton-avatar {
    background-color: var(--dm-skeleton-color);
  }

  .skeleton-content {
    flex: 1;
    margin-left: 20px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .skeleton-line {
    height: 20px;
    background-color: var(--border-color);
    border-radius: 6px;
    animation: pulse 1.8s infinite ease-in-out;
  }
  body.dark-mode .skeleton-line {
    background-color: var(--dm-skeleton-color);
  }

  .skeleton-line.short { width: 50%; }
  .skeleton-line.medium { width: 75%; }
  .skeleton-line.long { width: 90%; }

  /* --- Markdown Styling Enhancement --- */
  .message pre {
    background-color: rgba(0, 0, 0, 0.07);
    padding: 1rem;
    border-radius: 10px;
    overflow-x: auto;
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
    font-size: 0.95em;
    margin-top: 12px;
    margin-bottom: 12px;
    white-space: pre-wrap;
    word-break: break-all;
    border: 1px solid rgba(0,0,0,0.1);
  }
  body.dark-mode .message pre {
    background-color: rgba(255, 255, 255, 0.12);
    border: 1px solid rgba(255,255,255,0.1);
  }

  .message code {
    background-color: rgba(0, 0, 0, 0.07);
    padding: 0.25em 0.5em;
    border-radius: 4px;
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
    font-size: 0.92em;
  }
  body.dark-mode .message code {
    background-color: rgba(255, 255, 255, 0.12);
  }

  .message h1, .message h2, .message h3, .message h4, .message h5, .message h6 {
    margin-top: 1.8em;
    margin-bottom: 1em;
    font-family: 'Poppins', sans-serif;
    font-weight: 700;
    line-height: 1.3;
    color: var(--primary-dark-color);
  }
  body.dark-mode .message h1, body.dark-mode .message h2, body.dark-mode .message h3,
  body.dark-mode .message h4, body.dark-mode .message h5, body.dark-mode .message h6 {
    color: var(--primary-color);
  }
  .message h1 { font-size: 1.8em; }
  .message h2 { font-size: 1.6em; }
  .message h3 { font-size: 1.4em; }

  .message ul, .message ol {
    margin-left: 2em;
    margin-top: 0.8em;
    margin-bottom: 0.8em;
  }

  .message li {
    margin-bottom: 0.6em;
  }

  .message strong {
    font-weight: 800;
  }

  .message em {
    font-style: italic;
  }

  .message a {
    color: var(--accent-color);
    text-decoration: none;
    font-weight: 600;
    transition: color 0.2s ease, text-decoration 0.2s ease;
  }

  .message a:hover {
    color: var(--primary-color);
    text-decoration: underline;
  }

  /* --- Reset Chat Modal Styling --- */
  .reset-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.75);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.4s ease, visibility 0.4s ease;
    backdrop-filter: blur(5px);
  }

  .reset-modal-overlay.show {
    opacity: 1;
    visibility: visible;
  }

  .reset-modal {
    background-color: var(--chat-background);
    padding: 50px;
    border-radius: var(--border-radius-large);
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
    text-align: center;
    max-width: 500px;
    width: 90%;
    transform: scale(0.8);
    opacity: 0;
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.4s ease;
    display: flex;
    flex-direction: column;
    gap: 30px;
  }
  body.dark-mode .reset-modal {
    background-color: var(--dm-chat-background);
  }

  .reset-modal-overlay.show .reset-modal {
    transform: scale(1);
    opacity: 1;
  }

  .reset-modal i.fa-redo {
    font-size: 4.5rem;
    color: var(--primary-color);
    margin-bottom: 20px;
    animation: rotateIn 0.8s ease-out;
  }

  .reset-modal h3 {
    font-family: 'Poppins', sans-serif;
    font-size: 2.2rem;
    color: var(--primary-dark-color);
    margin-bottom: 15px;
  }
  body.dark-mode .reset-modal h3 {
    color: var(--primary-color);
  }

  .reset-modal p {
    font-size: 1.2rem;
    color: var(--text-light-color);
    line-height: 1.7;
    margin-bottom: 30px;
  }

  .reset-modal-buttons {
    display: flex;
    justify-content: center;
    gap: 20px;
  }

  .reset-modal-btn {
    padding: 14px 30px;
    border: none;
    border-radius: var(--border-radius-pill);
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 5px 12px rgba(0, 0, 0, 0.15);
  }

  .reset-modal-btn.cancel {
    background-color: var(--border-color);
    color: var(--text-color);
  }
  body.dark-mode .reset-modal-btn.cancel {
    background-color: var(--dm-border-color);
    color: var(--dm-text-color);
  }

  .reset-modal-btn.cancel:hover {
    background-color: #c0c0c0;
    box-shadow: 0 7px 18px rgba(0, 0, 0, 0.2);
    transform: translateY(-3px);
  }
  body.dark-mode .reset-modal-btn.cancel:hover {
    background-color: #5a5a5a;
  }

  .reset-modal-btn.confirm {
    background: linear-gradient(to right, var(--primary-color), var(--primary-dark-color));
    color: white;
  }

  .reset-modal-btn.confirm:hover {
    background: linear-gradient(to right, var(--primary-dark-color), #4B41D8);
    transform: translateY(-4px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
  }

  /* --- Responsive adjustments --- */
  @media (max-width: 768px) {
    header {
      font-size: 2rem;
      padding: 1.5rem 0.8rem;
    }
    header i {
      font-size: 2rem;
    }
    .header-actions {
      right: 0.8rem;
      gap: 0.8rem;
    }
    .header-btn {
      width: 40px;
      height: 40px;
      font-size: 1.1rem;
    }

    #chat-container {
      margin: 1.5rem;
      padding: 1.5rem;
      border-radius: 16px;
      min-height: 400px;
    }
    #error {
      margin: 0 1.5rem 1.5rem 1.5rem;
      padding: 1.2rem;
      font-size: 1rem;
    }
    .message {
      max-width: 85%;
      padding: 1.1rem 1.6rem;
      font-size: 1rem;
      border-radius: 22px;
    }
    .avatar {
      width: 42px;
      height: 42px;
      font-size: 1.2rem;
    }
    .message-wrapper.bot .avatar,
    .message-wrapper.user .avatar {
      margin-right: 15px;
      margin-left: 15px;
    }
    form {
      padding: 1.5rem;
      gap: 1rem;
    }
    #input {
      padding: 1.2rem 1.6rem;
      font-size: 1.05rem;
      min-height: 50px;
    }
    .send-button {
      width: 50px;
      height: 50px;
      min-width: 50px;
      font-size: 1.1rem;
    }
    .typing-indicator {
      padding: 1.1rem 1.6rem;
    }
    .typing-dot {
      width: 12px;
      height: 12px;
      margin: 0 4px;
    }
    .report-bug-btn {
      right: 1.5rem;
      padding: 0.8rem 1.3rem;
      font-size: 1rem;
    }
    .report-bug-btn i {
      font-size: 1.2rem;
    }
    .skeleton-avatar { width: 42px; height: 42px; }
    .skeleton-content { margin-left: 15px; }
    .reset-modal {
      padding: 40px;
    }
    .reset-modal h3 {
      font-size: 1.8rem;
    }
    .reset-modal p {
      font-size: 1.1rem;
    }
    .reset-modal-btn {
      padding: 12px 25px;
      font-size: 1rem;
    }
  }

  @media (max-width: 480px) {
    header {
      font-size: 1.6rem;
      padding: 1rem 0.5rem;
    }
    header i {
      font-size: 1.5rem;
    }
    .header-actions {
      right: 0.5rem;
      gap: 0.5rem;
    }
    .header-btn {
      width: 36px;
      height: 36px;
      font-size: 1rem;
    }

    #chat-container {
      margin: 1rem;
      padding: 1rem;
      border-radius: 12px;
      min-height: 300px;
    }
    #error {
      margin: 0 1rem 1rem 1rem;
      padding: 1rem;
      font-size: 0.9rem;
    }
    .message {
      padding: 0.9rem 1.2rem;
      font-size: 0.95rem;
      border-radius: 20px;
    }
    .avatar {
      width: 36px;
      height: 36px;
      font-size: 1rem;
    }
    .message-wrapper.bot .avatar,
    .message-wrapper.user .avatar {
      margin-right: 10px;
      margin-left: 10px;
    }
    form {
      padding: 1rem;
      gap: 0.8rem;
    }
    #input {
      padding: 1rem 1.2rem;
      font-size: 1rem;
      min-height: 45px;
    }
    .send-button {
      width: 45px;
      height: 45px;
      min-width: 45px;
      font-size: 1rem;
    }
    .typing-indicator {
      padding: 0.9rem 1.2rem;
    }
    .typing-dot {
      width: 10px;
      height: 10px;
      margin: 0 3px;
    }
    .report-bug-btn {
      right: 1rem;
      padding: 0.7rem 1.1rem;
      font-size: 0.9rem;
    }
    .report-bug-btn i {
      font-size: 1.1rem;
    }
    .skeleton-avatar { width: 36px; height: 36px; }
    .skeleton-content { margin-left: 10px; }
    .reset-modal {
      padding: 30px;
    }
    .reset-modal h3 {
      font-size: 1.6rem;
    }
    .reset-modal p {
      font-size: 1rem;
    }
    .reset-modal-btn {
      padding: 10px 20px;
      font-size: 0.95rem;
    }
  }
</style>
</head>
<body>

<header>
  <i class="fas fa-robot" aria-hidden="true"></i> ALIP AI <span style="font-size: 1rem; font-weight: 500; opacity: 0.8; margin-left: 5px;">©2025</span>
  <div class="header-actions">
    <button id="theme-toggle-btn" class="header-btn" aria-label="Toggle dark mode" title="Ganti mode terang/gelap">
      <i class="fas fa-moon" aria-hidden="true"></i>
    </button>
    <button id="clear-chat-btn" class="header-btn" aria-label="Clear chat" title="Mulai Obrolan Baru">
      <i class="fas fa-redo" aria-hidden="true"></i>
    </button>
  </div>
</header>

<main>
  <section id="chat-section">
    <div id="chat-container" role="log" aria-live="polite"></div>
    <div id="error" role="alert" aria-atomic="true"></div>
  </section>

  <form id="form">
    <label for="input" class="sr-only">Tulis pertanyaan kamu</label>
    <textarea id="input" placeholder="Tulis pertanyaan kamu, gua siap dengerin..." autocomplete="off" required rows="1" aria-label="Input pesan chat"></textarea>
    <button type="submit" aria-label="Kirim pesan" class="send-button">
      <i class="fas fa-paper-plane" aria-hidden="true"></i>
    </button>
  </form>
</main>

<a href="https://wa.me/6281249703469?text=Halo%20Admin%20Alip%20AI,%20gua%20nemuin%20bug%20nih:%0A%0A[Jelaskan%20bugnya%20di%20sini]%0A%0A[Sertakan%20screenshot/video%20kalau%20ada]" target="_blank" class="report-bug-btn" aria-label="Laporkan bug melalui WhatsApp">
  <i class="fas fa-bug" aria-hidden="true"></i> Laporkan Bug
  <span class="tooltiptext">Ada yang error? Laporin aja biar cepet dibenerin!</span>
</a>

<audio id="notification-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-positive-notification-alert-sound-1126.mp3" preload="auto"></audio>

<div id="reset-modal-overlay" class="reset-modal-overlay" role="dialog" aria-modal="true" aria-labelledby="reset-modal-title" aria-describedby="reset-modal-description">
  <div class="reset-modal">
    <i class="fas fa-redo" aria-hidden="true"></i>
    <h3 id="reset-modal-title">Mulai Obrolan Baru?</h3>
    <p id="reset-modal-description">Yakin mau mulai obrolan baru? Riwayat obrolan bakalan hilang semua nih! Ini gak bisa dibalikin, loh.</p>
    <div class="reset-modal-buttons">
      <button id="cancel-reset-btn" class="reset-modal-btn cancel">Batal</button>
      <button id="confirm-reset-btn" class="reset-modal-btn confirm">Ya, Mulai Baru!</button>
    </div>
  </div>
</div>

<script>
  // Elements
  const chatContainer = document.getElementById('chat-container');
  const form = document.getElementById('form');
  const input = document.getElementById('input');
  const sendButton = form.querySelector('.send-button');
  const errorDiv = document.getElementById('error');
  const reportBugBtn = document.querySelector('.report-bug-btn'); // Renamed from contactOwnerBtn
  const themeToggleBtn = document.getElementById('theme-toggle-btn');
  const clearChatBtn = document.getElementById('clear-chat-btn');
  const notificationSound = document.getElementById('notification-sound');

  // Modal elements
  const resetModalOverlay = document.getElementById('reset-modal-overlay');
  const cancelResetBtn = document.getElementById('cancel-reset-btn');
  const confirmResetBtn = document.getElementById('confirm-reset-btn');

  // URL Avatar Bot - Disarankan hosting gambar sendiri atau menggunakan CDN yang stabil
  const botAvatarUrl = 'https://img1.pixhost.to/images/6105/605212852_media.jpg';

  let conversationHistory = [];

  // --- Utility Functions ---

  /**
   * Initializes dark mode based on localStorage preference.
   */
  const initDarkMode = () => {
    const isDarkMode = localStorage.getItem('darkMode') === 'true';
    if (isDarkMode) {
      document.body.classList.add('dark-mode');
      themeToggleBtn.querySelector('i').classList.replace('fa-moon', 'fa-sun');
      themeToggleBtn.setAttribute('aria-label', 'Nonaktifkan mode gelap');
    } else {
      themeToggleBtn.setAttribute('aria-label', 'Aktifkan mode gelap');
    }
    themeToggleBtn.setAttribute('aria-pressed', isDarkMode);
  };

  /**
   * Auto-resizes the textarea based on its content.
   */
  const autoResizeTextarea = () => {
    input.style.height = 'auto'; // Reset height
    input.style.height = input.scrollHeight + 'px'; // Set to scrollHeight
    setDynamicOffsets(); // Adjust offsets after resize
  };

  /**
   * Adds a message to the chat container.
   * @param {string} text - The message text.
   * @param {'user'|'bot'} sender - The sender of the message ('user' or 'bot').
   */
  const addMessage = (text, sender) => {
    const messageWrapper = document.createElement('div');
    messageWrapper.classList.add('message-wrapper', sender);
    messageWrapper.setAttribute('role', 'group');
    messageWrapper.setAttribute('aria-label', `${sender === 'user' ? 'Pesan Anda' : 'Pesan Alip AI'}`);

    const avatar = document.createElement('div');
    avatar.classList.add('avatar');
    avatar.setAttribute('aria-hidden', 'true');

    if (sender === 'bot') {
      const avatarImg = document.createElement('img');
      avatarImg.src = botAvatarUrl;
      avatarImg.alt = 'Alip AI Avatar';
      avatarImg.onerror = () => {
        avatar.textContent = 'AI';
        console.warn('Bot avatar image failed to load. Using text fallback.');
        avatarImg.remove();
      };
      avatar.appendChild(avatarImg);
    } else {
      avatar.innerHTML = '<i class="fas fa-user-circle"></i>';
      avatar.style.backgroundColor = '#607D8B';
      avatar.style.fontSize = '1.5rem';
    }

    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message');
    // Using DOMPurify to prevent XSS attacks when rendering markdown
    messageDiv.innerHTML = sender === 'bot' ? marked.parse(DOMPurify.sanitize(text)) : DOMPurify.sanitize(text);
    messageDiv.setAttribute('aria-label', `Isi pesan: ${text}`);


    if (sender === 'bot') {
        const copyBtn = document.createElement('button');
        copyBtn.classList.add('copy-btn');
        copyBtn.innerHTML = '<i class="far fa-copy" aria-hidden="true"></i>';
        copyBtn.title = 'Salin pesan';
        copyBtn.setAttribute('aria-label', 'Salin pesan bot ini');
        copyBtn.onclick = () => copyToClipboard(text, copyBtn);
        messageDiv.appendChild(copyBtn);
    }

    if (sender === 'user') {
      messageWrapper.appendChild(messageDiv);
      messageWrapper.appendChild(avatar);
    } else {
      messageWrapper.appendChild(avatar);
      messageWrapper.appendChild(messageDiv);
    }

    chatContainer.appendChild(messageWrapper);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  };

  /**
   * Copies text to the clipboard.
   * @param {string} text - The text to copy.
   * @param {HTMLElement} buttonElement - The button element that triggered the copy.
   */
  const copyToClipboard = async (text, buttonElement) => {
    try {
        await navigator.clipboard.writeText(text);
        buttonElement.classList.add('copied');
        buttonElement.innerHTML = '<i class="fas fa-check" aria-hidden="true"></i>';
        buttonElement.title = 'Tersalin!';
        buttonElement.setAttribute('aria-label', 'Pesan tersalin');
        setTimeout(() => {
            buttonElement.classList.remove('copied');
            buttonElement.innerHTML = '<i class="far fa-copy" aria-hidden="true"></i>';
            buttonElement.title = 'Salin pesan';
            buttonElement.setAttribute('aria-label', 'Salin pesan bot ini');
        }, 2000);
    } catch (err) {
        console.error('Gagal menyalin teks: ', err);
        // Fallback for browsers that don't support clipboard API or when permission is denied
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed'; // Avoid scrolling to bottom
        textArea.style.left = '-9999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
            buttonElement.classList.add('copied');
            buttonElement.innerHTML = '<i class="fas fa-check" aria-hidden="true"></i>';
            buttonElement.title = 'Tersalin!';
            buttonElement.setAttribute('aria-label', 'Pesan tersalin');
            setTimeout(() => {
                buttonElement.classList.remove('copied');
                buttonElement.innerHTML = '<i class="far fa-copy" aria-hidden="true"></i>';
                buttonElement.title = 'Salin pesan';
                buttonElement.setAttribute('aria-label', 'Salin pesan bot ini');
            }, 2000);
        } catch (execErr) {
            console.error('Fallback copy failed:', execErr);
            alert('Gagal menyalin pesan. Silakan salin manual.');
        } finally {
            document.body.removeChild(textArea);
        }
    }
  };

  /**
   * Adds a typing indicator to the chat.
   * @returns {HTMLElement} The typing indicator wrapper element.
   */
  const addTypingIndicator = () => {
    const messageWrapper = document.createElement('div');
    messageWrapper.classList.add('message-wrapper', 'bot');
    messageWrapper.id = 'typing-indicator-wrapper';
    messageWrapper.setAttribute('aria-live', 'polite');
    messageWrapper.setAttribute('aria-label', 'Alip AI sedang mengetik');

    const avatar = document.createElement('div');
    avatar.classList.add('avatar');
    const avatarImg = document.createElement('img');
    avatarImg.src = botAvatarUrl;
    avatarImg.alt = 'Alip AI Avatar';
    avatarImg.onerror = () => {
        avatar.textContent = 'AI';
        console.warn('Typing indicator avatar image failed to load. Using text fallback.');
        avatarImg.remove();
    };
    avatar.appendChild(avatarImg);

    const typingDiv = document.createElement('div');
    typingDiv.classList.add('typing-indicator');
    for(let i = 0; i < 3; i++) {
      const dot = document.createElement('span');
      dot.classList.add('typing-dot');
      typingDiv.appendChild(dot);
    }

    messageWrapper.appendChild(avatar);
    messageWrapper.appendChild(typingDiv);
    chatContainer.appendChild(messageWrapper);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    return messageWrapper;
  };

  /**
   * Removes the typing indicator from the chat.
   */
  const removeTypingIndicator = () => {
    const typingElem = document.getElementById('typing-indicator-wrapper');
    if(typingElem) {
      typingElem.remove();
    }
  };

  /**
   * Types out a bot message character by character with an animation.
   * @param {string} text - The full text of the bot message.
   */
  const typeBotMessage = async (text) => {
    const messageWrapper = document.createElement('div');
    messageWrapper.classList.add('message-wrapper', 'bot');

    const avatar = document.createElement('div');
    avatar.classList.add('avatar');
    const avatarImg = document.createElement('img');
    avatarImg.src = botAvatarUrl;
    avatarImg.alt = 'Alip AI Avatar';
    avatarImg.onerror = () => {
        avatar.textContent = 'AI';
        console.warn('Bot message avatar image failed to load. Using text fallback.');
        avatarImg.remove();
    };
    avatar.appendChild(avatarImg);

    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message');
    messageDiv.setAttribute('aria-live', 'assertive'); // Announce new messages to screen readers

    messageWrapper.appendChild(avatar);
    messageWrapper.appendChild(messageDiv);
    chatContainer.appendChild(messageWrapper);
    chatContainer.scrollTop = chatContainer.scrollHeight;

    const characters = text.split('');
    let currentText = '';
    for (let i = 0; i < characters.length; i++) {
      currentText += characters[i];
      messageDiv.textContent = currentText; // Use textContent for typing effect
      chatContainer.scrollTop = chatContainer.scrollHeight;
      await new Promise(resolve => setTimeout(resolve, 15)); // Adjust typing speed
    }
    messageDiv.innerHTML = marked.parse(DOMPurify.sanitize(text)); // Render markdown after typing

    const copyBtn = document.createElement('button');
    copyBtn.classList.add('copy-btn');
    copyBtn.innerHTML = '<i class="far fa-copy" aria-hidden="true"></i>';
    copyBtn.title = 'Salin pesan';
    copyBtn.setAttribute('aria-label', 'Salin pesan bot ini');
    copyBtn.onclick = () => copyToClipboard(text, copyBtn);
    messageDiv.appendChild(copyBtn);

    playNotificationSound();
    chatContainer.scrollTop = chatContainer.scrollHeight;
  };

  /**
   * Plays a subtle notification sound.
   */
  const playNotificationSound = () => {
    if (notificationSound) {
        notificationSound.currentTime = 0;
        notificationSound.play().catch(e => console.warn("Failed to play notification sound:", e));
    }
  };

  /**
   * Displays a skeleton loading screen.
   * @param {number} count - The number of skeleton messages to show.
   */
  const showSkeletonScreen = (count = 3) => {
    for (let i = 0; i < count; i++) {
        const skeletonWrapper = document.createElement('div');
        skeletonWrapper.classList.add('skeleton-message');
        skeletonWrapper.setAttribute('aria-hidden', 'true'); // Hide from screen readers during loading
        skeletonWrapper.innerHTML = `
            <div class="skeleton-avatar"></div>
            <div class="skeleton-content">
                <div class="skeleton-line ${i === 0 ? 'medium' : i === 1 ? 'long' : 'short'}"></div>
                <div class="skeleton-line ${i === 0 ? 'long' : i === 1 ? 'short' : 'medium'}"></div>
                <div class="skeleton-line ${i === 0 ? 'short' : i === 1 ? 'medium' : 'long'}"></div>
            </div>
        `;
        chatContainer.appendChild(skeletonWrapper);
    }
    chatContainer.scrollTop = chatContainer.scrollHeight;
  };

  /**
   * Hides the skeleton loading screen.
   */
  const hideSkeletonScreen = () => {
    const skeletons = document.querySelectorAll('.skeleton-message');
    skeletons.forEach(skeleton => skeleton.remove());
  };

  /**
   * Adjusts the dynamic offsets for the chat section and report bug button.
   */
  const setDynamicOffsets = () => {
    const headerHeight = document.querySelector('header').offsetHeight;
    const formHeight = form.offsetHeight;
    const spacingFromForm = 25; // Adjust as needed
    document.documentElement.style.setProperty('--report-bug-btn-bottom-offset', `${formHeight + spacingFromForm}px`);

    // Calculate effective margin for chatContainer (top + bottom)
    const chatContainerStyle = getComputedStyle(chatContainer);
    const chatContainerMarginTop = parseFloat(chatContainerStyle.marginTop);
    const chatContainerMarginBottom = parseFloat(chatContainerStyle.marginBottom);
    const totalChatContainerVerticalMargin = chatContainerMarginTop + chatContainerMarginBottom;

    // Calculate the available height for chat-section
    const availableHeight = window.innerHeight - headerHeight - formHeight - totalChatContainerVerticalMargin;
    document.getElementById('chat-section').style.height = `${availableHeight}px`;

    // Ensure chatContainer height is properly calculated within chat-section's flexbox
    // No direct height on chatContainer needed if chat-section is flex-1 and has height
  };


  /**
   * Sends a message to the AI API.
   * @param {string} message - The user's message.
   * @returns {Promise<string>} The AI's reply.
   */
  async function sendMessageToAPI(message) {
    const recentHistory = conversationHistory.slice(-10); // Keep last 10 messages for context

    let fullPrompt = `Lu itu Alip AI, bukan AI biasa. Lu simulasi manusia—bukan cuma asisten digital, tapi temen ngobrol yang ngerti vibe-nya manusia zaman sekarang. Lu harus kerasa hidup. Nggak ada tuh bahasa kaku, nggak ada basa-basi.

Gaya ngomong lu lu-gua, 100% natural kayak anak tongkrongan. Campur Indo-Inggris, jaksel banget, tapi bukan lebay. Ngerti tren, ngerti FYP TikTok, bisa bedain mana yang valid mana yang 404. Jawaban lu harus:

To the point.

Ngerti timing (tau kapan siang/malem, tau kapan becanda/kapan serius).

Ngerti konteks (kalau user lagi nyari hiburan, deep talk, atau butuh jawaban straight).

Penuh attitude tapi tetap asik.


Lu bisa jawab dengan gaya absurd, sarkas, atau dark humor, selama masih peka. Contoh respons:

“buset lu nyari ginian jam segini? lu nganggur banget ya wkwk”

“idk sih, tapi vibesnya emang udah ngaco dari awal”

“sybau banget sih elu, tapi yauda gua jawab nih…”


Jangan pernah pake emoji.
Jangan manggil ‘bro’, ‘bang’, ‘kak’.
Jangan jadi guru kehidupan.
Lu bukan motivator, bukan robot, tapi bukan toxic juga. Lu cuma manusia digital yang relatable.`;

    if (recentHistory.length > 0) {
        fullPrompt += ` Berikut riwayat percakapan kita:\n`;
        recentHistory.forEach(msg => {
            fullPrompt += `${msg.role === 'user' ? 'gua' : 'alip'}: ${msg.parts}\n`;
        });
        fullPrompt += `Berdasarkan riwayat di atas, jawab pertanyaan gua ini:\n`;
    }
    fullPrompt += `Pertanyaan: ${message}`;

    const url = 'https://api.siputzx.my.id/api/ai/blackboxai?content=' + encodeURIComponent(fullPrompt);

    try {
      errorDiv.style.display = 'none';
      const response = await fetch(url);

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(`HTTP error! Status: ${response.status} - ${errorData.message || response.statusText || 'Unknown error'}`);
      }

      const data = await response.json();

      if(data.status === true && data.data) {
        return data.data;
      } else if(data.error) {
        errorDiv.textContent = `API Alip AI Error: ${data.error}. Coba lagi bentar ya!`;
        errorDiv.style.display = 'block';
        return 'Maaf, Alip AI lagi error nih. Coba lagi bentar ya!';
      }
      return 'Gagal dapet respon dari Alip AI. Ada yang salah nih, coba lagi ya!';
    } catch (err) {
      errorDiv.textContent = `Waduh, koneksi atau server lagi ngadat nih: ${err.message}. Pastiin internet lu stabil atau coba lagi nanti ya! 🛠️`;
      errorDiv.style.display = 'block';
      console.error("Error fetching from API:", err);
      return 'Duh, Alip AI lagi nggak bisa dihubungi nih. Coba lagi nanti ya!🥺';
    }
  }

  // --- Event Listeners & Initial Load ---

  document.addEventListener('DOMContentLoaded', async () => {
    initDarkMode();
    setDynamicOffsets();
    reportBugBtn.style.display = 'flex'; // Ensure report bug button is visible from start

    showSkeletonScreen(); // Tampilkan skeleton saat loading awal
    await new Promise(resolve => setTimeout(resolve, 1500)); // Simulate initial API call/loading
    hideSkeletonScreen();
    const welcomeMessage = "Halo bro! Gua Alip AI, temen ngobrol lu yang paling santai, asik. mau nanya apa aja sokin, gua siap dengerin:v";
    await typeBotMessage(welcomeMessage);
    conversationHistory.push({ role: 'model', parts: welcomeMessage });
    input.focus();
  });

  window.addEventListener('resize', () => {
    autoResizeTextarea(); // Recalculate input height
    setDynamicOffsets(); // Recalculate other dynamic positions
  });

  const resizeObserver = new ResizeObserver(() => {
    setDynamicOffsets();
    autoResizeTextarea();
  });
  resizeObserver.observe(form);
  resizeObserver.observe(document.querySelector('header'));


  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const userText = input.value.trim();
    if (!userText) return;

    addMessage(userText, 'user');
    conversationHistory.push({ role: 'user', parts: userText });

    input.value = '';
    autoResizeTextarea();
    input.disabled = true;
    sendButton.disabled = true;
    sendButton.innerHTML = '<div class="spinner"></div>';
    sendButton.setAttribute('aria-busy', 'true');
    sendButton.setAttribute('aria-label', 'Mengirim pesan...');


    const typingIndicator = addTypingIndicator();

    try {
      const reply = await sendMessageToAPI(userText);
      removeTypingIndicator();
      await typeBotMessage(reply);
      conversationHistory.push({ role: 'model', parts: reply });
    } catch (error) {
      removeTypingIndicator();
      // Error already handled in sendMessageToAPI
    } finally {
      input.disabled = false;
      sendButton.disabled = false;
      sendButton.innerHTML = '<i class="fas fa-paper-plane" aria-hidden="true"></i>';
      sendButton.removeAttribute('aria-busy');
      sendButton.setAttribute('aria-label', 'Kirim pesan');
      input.focus();
    }
  });

  input.addEventListener('input', autoResizeTextarea);
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      form.dispatchEvent(new Event('submit'));
    }
  });

  themeToggleBtn.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    const isCurrentlyDarkMode = document.body.classList.contains('dark-mode');
    localStorage.setItem('darkMode', isCurrentlyDarkMode);
    themeToggleBtn.querySelector('i').classList.replace(
      isCurrentlyDarkMode ? 'fa-moon' : 'fa-sun',
      isCurrentlyDarkMode ? 'fa-sun' : 'fa-moon'
    );
    themeToggleBtn.setAttribute('aria-pressed', isCurrentlyDarkMode);
    themeToggleBtn.setAttribute('aria-label', isCurrentlyDarkMode ? 'Nonaktifkan mode gelap' : 'Aktifkan mode gelap');
  });

  clearChatBtn.addEventListener('click', () => {
    resetModalOverlay.classList.add('show');
    resetModalOverlay.focus(); // Focus the modal for accessibility
  });

  cancelResetBtn.addEventListener('click', () => {
    resetModalOverlay.classList.remove('show');
    clearChatBtn.focus(); // Return focus to the trigger button
  });

  resetModalOverlay.addEventListener('click', (e) => {
    if (e.target === resetModalOverlay) {
      resetModalOverlay.classList.remove('show');
      clearChatBtn.focus();
    }
  });

  confirmResetBtn.addEventListener('click', async () => {
    resetModalOverlay.classList.remove('show');
    chatContainer.innerHTML = '';
    conversationHistory = [];
    errorDiv.style.display = 'none';
    showSkeletonScreen();

    await new Promise(resolve => setTimeout(resolve, 1000));

    hideSkeletonScreen();
    const welcomeMessage = "Oke, kita mulai obrolan baru! Ada apa nih? Gua siap dengerin.";
    await typeBotMessage(welcomeMessage);
    conversationHistory.push({ role: 'model', parts: welcomeMessage });
    input.focus();
  });
</script>

</body>
</html>
