<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Alip AI - Asisten AI Cerdas</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
  /* --- CSS Variables & Theme Management --- */
  :root {
    /* Dark Mode Colors (Default) */
    --bg-primary: #17171C; /* Darker, modern background */
    --surface-main: #202026; /* Main panel/chat background */
    --surface-light: #2C2C35; /* Header, form, sidebar background */
    --text-primary: #E0E0E0; /* Light text */
    --text-secondary: #9CA3AF; /* Lighter grey text */
    --accent-blue: #4F46E5; /* Calmer purplish blue */
    --accent-purple: #8B5CF6; /* Calmer purple */
    --border-color: #3F3F46; /* Subtle border */
    --input-bg: #3F3F46; /* Input field background */
    --input-focus-border: #6B7280; /* Input focus border */
    --user-bubble-bg: #4F46E5; /* User message bubble (accent-blue) */
    --bot-bubble-bg: #374151; /* Bot message bubble (dark grey) */
    --error-bg: #FECACA; /* Error background */
    --error-text: #DC2626; /* Error text */
    --button-bg: var(--accent-blue);
    --button-hover-bg: var(--accent-purple);
    --shadow-light: rgba(0, 0, 0, 0.1);
    --shadow-medium: rgba(0, 0, 0, 0.2);
    --shadow-strong: rgba(0, 0, 0, 0.4);

    /* Light Mode Colors */
    --light-bg-primary: #F3F4F6;
    --light-surface-main: #FFFFFF;
    --light-surface-light: #E5E7EB;
    --light-text-primary: #1F2937;
    --light-text-secondary: #6B7280;
    --light-accent-blue: #1D4ED8;
    --light-accent-purple: #7C3AED;
    --light-border-color: #D1D5DB;
    --light-input-bg: #F9FAFB;
    --light-input-focus-border: #9CA3AF;
    --light-user-bubble-bg: #DBEAFE;
    --light-bot-bubble-bg: #E5E7EB;
    --light-error-bg: #FEE2E2;
    --light-error-text: #EF4444;
    --light-button-bg: var(--light-accent-blue);
    --light-button-hover-bg: var(--light-accent-purple);
    --light-shadow-light: rgba(0, 0, 0, 0.05);
    --light-shadow-medium: rgba(0, 0, 0, 0.1);
    --light-shadow-strong: rgba(0, 0, 0, 0.2);

    /* Transitions & Animations */
    --transition-duration: 0.25s; /* Faster for responsive feel */
    --transition-ease: ease-in-out;
  }

  /* Activate Light Mode */
  body.light-mode {
    --bg-primary: var(--light-bg-primary);
    --surface-main: var(--light-surface-main);
    --surface-light: var(--light-surface-light);
    --text-primary: var(--light-text-primary);
    --text-secondary: var(--light-text-secondary);
    --accent-blue: var(--light-accent-blue);
    --accent-purple: var(--light-accent-purple);
    --border-color: var(--light-border-color);
    --input-bg: var(--light-input-bg);
    --input-focus-border: var(--light-input-focus-border);
    --user-bubble-bg: var(--light-user-bubble-bg);
    --bot-bubble-bg: var(--light-bot-bubble-bg);
    --error-bg: var(--light-error-bg);
    --error-text: var(--light-error-text);
    --button-bg: var(--light-button-bg);
    --button-hover-bg: var(--light-button-hover-bg);
    --shadow-light: var(--light-shadow-light);
    --shadow-medium: var(--light-shadow-medium);
    --shadow-strong: var(--light-shadow-strong);
  }

  /* --- Global Styles & Body --- */
  * {
    box-sizing: border-box;
  }

  html {
    scroll-behavior: smooth;
  }

  body {
    margin: 0;
    padding: 0;
    font-family: 'Inter', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow: hidden;
    position: relative;
    overscroll-behavior: none;
    transition: background var(--transition-duration) var(--transition-ease), color var(--transition-duration) var(--transition-ease);
  }

  /* Custom Scrollbar */
  ::-webkit-scrollbar {
    width: 8px;
  }
  ::-webkit-scrollbar-track {
    background: var(--surface-main);
  }
  ::-webkit-scrollbar-thumb {
    background: var(--text-secondary);
    border-radius: 4px;
    transition: background var(--transition-duration);
  }
  ::-webkit-scrollbar-thumb:hover {
    background: var(--accent-blue);
  }

  /* --- Header --- */
  header {
    background: var(--surface-light);
    padding: 1rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 8px var(--shadow-medium);
    z-index: 100;
    border-bottom: 1px solid var(--border-color);
    flex-shrink: 0;
    transition: background var(--transition-duration) var(--transition-ease), border-color var(--transition-duration) var(--transition-ease), box-shadow var(--transition-duration) var(--transition-ease);
  }

  .logo {
    display: flex;
    align-items: center;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--accent-blue);
    letter-spacing: 0.5px;
    transition: color var(--transition-duration) var(--transition-ease);
  }

  .logo i {
    font-size: 1.3rem;
    margin-right: 8px;
    color: var(--accent-purple);
    transition: color var(--transition-duration) var(--transition-ease);
  }

  /* Removed nav styles as nav is removed from HTML */

  /* --- Main Content Area --- */
  #main-content {
    flex: 1;
    display: flex;
    position: relative;
    overflow: hidden;
    padding: 20px;
    box-sizing: border-box;
    justify-content: center;
  }

  /* Chat Container */
  #chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 1.5rem;
    overflow-y: auto;
    scroll-behavior: smooth;
    background: var(--surface-main);
    border-radius: 12px;
    box-shadow: 0 4px 20px var(--shadow-strong);
    max-width: 800px;
    width: 100%;
    border: 1px solid var(--border-color);
    /* margin-bottom handled by JS for dynamic form height */
    transition: background var(--transition-duration) var(--transition-ease), border-color var(--transition-duration) var(--transition-ease), box-shadow var(--transition-duration) var(--transition-ease);
  }

  .message-wrapper {
    display: flex;
    margin-bottom: 1.2rem;
    align-items: flex-start;
    opacity: 0;
    transform: translateY(10px);
    animation: fadeIn 0.4s var(--transition-ease) forwards;
  }

  .message-wrapper.user {
    justify-content: flex-end;
  }

  .message-wrapper.bot {
    justify-content: flex-start;
  }

  .avatar {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    background-color: var(--accent-blue);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    font-weight: 600;
    color: white;
    flex-shrink: 0;
    overflow: hidden;
    transition: transform 0.2s var(--transition-ease), background-color var(--transition-duration) var(--transition-ease);
  }

  .avatar:hover {
    transform: scale(1.05);
  }

  .avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .message-wrapper.bot .avatar {
    margin-right: 12px;
  }

  .message-wrapper.user .avatar {
    order: 2;
    margin-left: 12px;
    background-color: var(--accent-purple);
  }

  .message {
    max-width: 75%;
    padding: 0.8rem 1.2rem;
    border-radius: 18px;
    line-height: 1.6;
    white-space: pre-wrap;
    box-shadow: 0 2px 10px var(--shadow-light);
    word-wrap: break-word;
    font-size: 0.95rem;
    transition: all 0.3s var(--transition-ease);
    color: var(--text-primary);
  }

  .message pre {
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 6px;
    padding: 0.6rem;
    margin: 0.5rem 0;
    overflow-x: auto;
    font-family: monospace;
    font-size: 0.85rem;
    line-height: 1.4;
  }

  .user .message {
    background: var(--user-bubble-bg);
    color: white; /* Better contrast for user bubble */
    border-bottom-right-radius: 6px;
  }

  .bot .message {
    background: var(--bot-bubble-bg);
    border-bottom-left-radius: 6px;
  }

  /* --- Input Form --- */
  form {
    display: flex;
    padding: 1.2rem 20px;
    background: var(--surface-light);
    border-top: 1px solid var(--border-color);
    box-shadow: 0 -4px 15px var(--shadow-medium);
    gap: 0.8rem;
    align-items: center;
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    box-sizing: border-box;
    z-index: 100;
    flex-shrink: 0;
    transition: background var(--transition-duration) var(--transition-ease), border-color var(--transition-duration) var(--transition-ease), box-shadow var(--transition-duration) var(--transition-ease);
  }

  input[type="text"] {
    flex: 1;
    padding: 0.9rem 1.2rem;
    font-size: 1rem;
    border-radius: 25px;
    border: 1px solid var(--border-color);
    outline: none;
    background-color: var(--input-bg);
    color: var(--text-primary);
    transition: border-color var(--transition-duration) var(--transition-ease),
                box-shadow var(--transition-duration) var(--transition-ease),
                background-color var(--transition-duration) var(--transition-ease),
                color var(--transition-duration) var(--transition-ease);
  }

  input[type="text"]::placeholder {
    color: var(--text-secondary);
  }

  input[type="text"]:focus {
    border-color: var(--accent-blue);
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3); /* Calmer shadow color */
    background-color: var(--surface-main); /* Slightly change background on focus */
  }

  button[type="submit"] {
    background: var(--button-bg);
    border: none;
    border-radius: 50%;
    color: white;
    font-weight: 600;
    font-size: 1.1rem;
    cursor: pointer;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s var(--transition-ease);
    box-shadow: 0 2px 8px var(--shadow-medium);
  }

  button[type="submit"]:hover:not(:disabled) {
    background: var(--button-hover-bg);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px var(--shadow-strong);
  }

  button[type="submit"]:active:not(:disabled) {
    transform: translateY(0);
    box-shadow: 0 1px 5px var(--shadow-light);
  }

  button[type="submit"]:disabled {
    background: #6B7280;
    cursor: not-allowed;
    opacity: 0.7;
    box-shadow: none;
    transform: none;
  }

  /* Scroll to bottom button */
  #scrollToBottomBtn {
    position: absolute;
    bottom: calc(var(--form-height, 80px) + 30px); /* Adjusted by JS */
    right: 50%;
    transform: translateX(50%);
    background: var(--button-bg);
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    cursor: pointer;
    box-shadow: 0 2px 10px var(--shadow-medium);
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s var(--transition-ease);
    z-index: 99;
  }

  #scrollToBottomBtn.show {
    opacity: 1;
    visibility: visible;
    bottom: calc(var(--form-height, 80px) + 20px); /* Adjusted by JS */
  }

  #scrollToBottomBtn:hover {
    background: var(--button-hover-bg);
    transform: translateX(50%) translateY(-2px) scale(1.03);
  }

  /* --- Error Message --- */
  #error {
    color: var(--error-text);
    background-color: var(--error-bg);
    border: 1px solid var(--error-text);
    text-align: center;
    padding: 0.8rem;
    border-radius: 8px;
    margin: 0 auto 15px auto; /* Adjusted by JS for dynamic form height */
    font-size: 0.9rem;
    font-weight: 500;
    display: none;
    box-shadow: 0 2px 8px var(--shadow-light);
    flex-shrink: 0;
    max-width: 800px;
    width: 100%;
    transition: margin-bottom var(--transition-duration) var(--transition-ease), background-color var(--transition-duration) var(--transition-ease);
  }

  /* --- Typing Animation --- */
  .typing-indicator {
    display: flex;
    align-items: center;
    padding: 0.8rem 1.2rem;
    background: var(--bot-bubble-bg);
    border-radius: 18px;
    box-shadow: 0 2px 10px var(--shadow-light);
    max-width: fit-content;
    border-bottom-left-radius: 6px;
    transition: background var(--transition-duration) var(--transition-ease);
  }

  .typing-dot {
    width: 8px;
    height: 8px;
    margin: 0 3px;
    background-color: var(--text-secondary);
    border-radius: 50%;
    opacity: 0;
    animation: typing-fade 1.2s infinite ease-in-out;
    transition: background-color var(--transition-duration) var(--transition-ease);
  }

  .typing-dot:nth-child(1) { animation-delay: 0s; }
  .typing-dot:nth-child(2) { animation-delay: 0.2s; }
  .typing-dot:nth-child(3) { animation-delay: 0.4s; }

  @keyframes typing-fade {
    0%, 80%, 100% { opacity: 0; transform: scale(0.8); }
    40% { opacity: 1; transform: scale(1); }
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* --- Sidebar / Floating Menu --- */
  .sidebar-toggle {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 50px;
    height: 50px;
    background: var(--button-bg);
    color: white;
    border: none;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
    cursor: pointer;
    box-shadow: 0 4px 15px var(--shadow-medium);
    transition: all 0.2s var(--transition-ease);
    z-index: 200;
  }

  .sidebar-toggle:hover {
    background: var(--button-hover-bg);
    transform: rotate(90deg) scale(1.05);
    box-shadow: 0 6px 20px var(--shadow-strong);
  }

  #sidebar {
    position: fixed;
    top: 0;
    right: -250px; /* Default sidebar width */
    width: 250px;
    height: 100%;
    background: var(--surface-light);
    box-shadow: -4px 0 20px var(--shadow-strong);
    transition: right 0.3s var(--transition-ease), background var(--transition-duration) var(--transition-ease), border-color var(--transition-duration) var(--transition-ease);
    z-index: 199;
    padding: 25px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    border-left: 1px solid var(--border-color);
    align-items: center;
  }

  #sidebar.open {
    right: 0;
  }

  #sidebar h3 {
    color: var(--accent-blue);
    text-align: center;
    margin-bottom: 30px;
    transition: color var(--transition-duration) var(--transition-ease);
    font-size: 1.4rem;
  }

  .sidebar-options {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    gap: 15px;
    width: 100%;
    max-width: 200px;
  }

  .sidebar-options button {
    width: 100%;
    padding: 0.9rem;
    background: var(--input-bg);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: all 0.2s var(--transition-ease);
    box-shadow: 0 1px 5px var(--shadow-light);
  }

  .sidebar-options-button { /* For links wrapping buttons */
    text-decoration: none;
    display: block;
    width: 100%;
  }

  .sidebar-options button:hover, .sidebar-options-button button:hover {
    background: var(--accent-blue);
    color: white;
    border-color: var(--accent-blue);
    box-shadow: 0 2px 8px var(--shadow-medium);
    transform: translateY(-1px);
  }

  .sidebar-options button i, .sidebar-options-button button i {
    font-size: 1.1rem;
  }

  /* Dark/Light Mode Toggle in Sidebar */
  .theme-toggle-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
    padding: 10px 0;
    border-bottom: 1px solid var(--border-color);
    transition: border-color var(--transition-duration) var(--transition-ease);
  }

  .theme-toggle-wrapper span {
    font-size: 0.9rem;
    color: var(--text-secondary);
    transition: color var(--transition-duration) var(--transition-ease);
  }

  .theme-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 28px;
  }

  .theme-switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #6B7280; /* Default grey */
    transition: .4s;
    border-radius: 28px;
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
  }

  input:checked + .slider {
    background-color: var(--accent-blue);
  }

  input:checked + .slider:before {
    transform: translateX(22px);
    background-color: white;
  }

  /* --- Footer --- */
  footer {
    background: var(--surface-light);
    color: var(--text-secondary);
    text-align: center;
    padding: 0.8rem 1.5rem;
    font-size: 0.85rem;
    border-top: 1px solid var(--border-color);
    box-shadow: 0 -2px 8px var(--shadow-light);
    flex-shrink: 0;
    transition: background var(--transition-duration) var(--transition-ease), border-color var(--transition-duration) var(--transition-ease), color var(--transition-duration) var(--transition-ease);
  }

  footer a {
    color: var(--accent-blue);
    text-decoration: none;
    font-weight: 500;
    transition: color var(--transition-duration) var(--transition-ease);
  }

  footer a:hover {
    color: var(--accent-purple);
  }

  /* --- Responsive Adjustments --- */
  @media (max-width: 768px) {
    header {
      flex-direction: column;
      align-items: flex-start;
      padding: 0.8rem;
    }
    .logo {
      font-size: 1.3rem;
      margin-bottom: 0; /* Remove margin as nav is gone */
    }
    .logo i {
        font-size: 1.1rem;
    }
    /* Nav styles are removed */
    #main-content {
      padding: 15px;
    }
    #chat-container {
      padding: 1rem;
      border-radius: 10px;
    }
    #error {
      margin: 0 auto 10px auto;
      padding: 0.7rem;
    }
    .message {
      max-width: 90%;
      padding: 0.7rem 1rem;
      font-size: 0.9rem;
      border-radius: 14px;
    }
    .avatar {
      width: 32px;
      height: 32px;
      font-size: 0.8rem;
    }
    .message-wrapper.bot .avatar,
    .message-wrapper.user .avatar {
      margin-right: 8px;
      margin-left: 8px;
    }
    form {
      padding: 1rem 15px;
      gap: 0.6rem;
    }
    input[type="text"] {
      padding: 0.8rem 1rem;
      font-size: 0.9rem;
      border-radius: 20px;
    }
    button[type="submit"] {
      width: 42px;
      height: 42px;
      font-size: 1rem;
    }
    .typing-indicator {
      padding: 0.7rem 1rem;
    }
    .typing-dot {
      width: 7px;
      height: 7px;
      margin: 0 2px;
    }
    .sidebar-toggle {
      top: 15px;
      right: 15px;
      width: 45px;
      height: 45px;
      font-size: 1.2rem;
    }
    #sidebar {
      width: 220px;
      right: -220px;
      padding: 20px;
    }
    #sidebar h3 {
        font-size: 1.2rem;
        margin-bottom: 25px;
    }
    .sidebar-options button {
        padding: 0.8rem;
        font-size: 0.9rem;
    }
    .theme-toggle-wrapper {
        gap: 8px;
        margin-bottom: 15px;
    }
    .theme-toggle-wrapper span {
        font-size: 0.8rem;
    }
    .theme-switch {
        width: 45px;
        height: 25px;
    }
    .slider:before {
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
    }
    input:checked + .slider:before {
        transform: translateX(20px);
    }
    #scrollToBottomBtn {
        width: 35px;
        height: 35px;
        font-size: 0.9rem;
        bottom: calc(var(--form-height, 80px) + 25px);
    }
    #scrollToBottomBtn.show {
        bottom: calc(var(--form-height, 80px) + 15px);
    }
    footer {
        padding: 0.7rem;
        font-size: 0.75rem;
    }
  }
</style>
</head>
<body>

<header>
  <div class="logo" aria-label="Alip AI Logo"><i class="fas fa-robot"></i> ALIP AI</div>
  </header>

<div id="main-content">
  <div id="chat-container" aria-live="polite" aria-atomic="true"></div>
  <div id="error" role="alert" aria-hidden="true"></div>

  <button id="scrollToBottomBtn" title="Gulir ke Bawah" aria-label="Gulir ke pesan terbaru">
    <i class="fas fa-arrow-down"></i>
  </button>

  <button class="sidebar-toggle" id="sidebarToggle" aria-controls="sidebar" aria-expanded="false" title="Buka/Tutup Pengaturan">
    <i class="fas fa-bars"></i>
  </button>

  <aside id="sidebar" aria-label="Pengaturan dan Opsi">
    <h3>Pengaturan AI</h3>
    <div class="theme-toggle-wrapper">
        <span aria-hidden="true">Gelap</span>
        <label class="theme-switch" for="darkModeToggle">
            <input type="checkbox" id="darkModeToggle" checked aria-label="Tombol mode gelap">
            <span class="slider round"></span>
        </label>
        <span aria-hidden="true">Terang</span>
    </div>
    <div class="sidebar-options">
      <button id="clearChatBtn" aria-label="Bersihkan semua obrolan"><i class="fas fa-redo"></i> Bersihkan Chat</button>
      <button id="downloadChatBtn" aria-label="Unduh riwayat obrolan"><i class="fas fa-download"></i> Unduh Chat</button>
      <a href="https://wa.me/6281249703469" target="_blank" class="sidebar-options-button" rel="noopener noreferrer">
        <button aria-label="Laporkan bug via WhatsApp"><i class="fab fa-whatsapp"></i> Laporkan Bug</button>
      </a>
      <button id="newChatBtn" aria-label="Mulai obrolan baru"><i class="fas fa-plus"></i> Obrolan Baru</button>
      </div>
  </aside>

  </div>

<form id="chat-form">
  <input type="text" id="input" placeholder="Ketik pesanmu..." autocomplete="off" required aria-label="Area input pesan" />
  <button type="submit" aria-label="Kirim pesan">
    <i class="fas fa-paper-plane"></i>
  </button>
</form>

<footer>
    <span>&copy; <span id="currentYear"></span> Alip AI. Dibuat dengan <i class="fas fa-heart" style="color: #e0245e;"></i> oleh <a href="https://wa.me/6281249703469" target="_blank" rel="noopener noreferrer">Ahmad Alif</a>.</span>
</footer>

<script>
  // DOM Element References
  const chatContainer = document.getElementById('chat-container');
  const chatForm = document.getElementById('chat-form');
  const input = document.getElementById('input');
  const errorDiv = document.getElementById('error');
  const sidebarToggle = document.getElementById('sidebarToggle');
  const sidebar = document.getElementById('sidebar');
  const clearChatBtn = document.getElementById('clearChatBtn');
  const downloadChatBtn = document.getElementById('downloadChatBtn');
  const darkModeToggle = document.getElementById('darkModeToggle');
  const scrollToBottomBtn = document.getElementById('scrollToBottomBtn');
  const newChatBtn = document.getElementById('newChatBtn');

  // Bot Avatar URL
  const botAvatarUrl = 'https://img1.pixhost.to/images/6105/605212852_media.jpg';

  let conversationHistory = []; // Stores chat history for API context

  // Function to add a message to the chat container
  function addMessage(text, sender) {
    const messageWrapper = document.createElement('div');
    messageWrapper.classList.add('message-wrapper', sender);

    const avatar = document.createElement('div');
    avatar.classList.add('avatar');
    avatar.setAttribute('role', 'img');
    avatar.setAttribute('aria-label', sender === 'bot' ? 'Alip AI Avatar' : 'Your Avatar');

    if (sender === 'bot') {
      const avatarImg = document.createElement('img');
      avatarImg.src = botAvatarUrl;
      avatarImg.alt = 'Alip AI Avatar';
      avatarImg.onerror = () => { // Fallback if image fails to load
        avatar.textContent = 'AI';
        console.warn('Bot avatar image failed to load. Using text fallback.');
        avatarImg.remove();
      };
      avatar.appendChild(avatarImg);
    } else {
      avatar.textContent = 'Anda';
      avatar.style.backgroundColor = 'var(--accent-purple)';
    }

    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message');
    messageDiv.innerHTML = formatMessage(text); // Format message content

    if (sender === 'user') {
      messageWrapper.appendChild(messageDiv);
      messageWrapper.appendChild(avatar);
    } else {
      messageWrapper.appendChild(avatar);
      messageWrapper.appendChild(messageDiv);
    }

    chatContainer.appendChild(messageWrapper);
    scrollToBottom(); // Always scroll to bottom after new message
  }

  // Function to format messages (e.g., for code blocks)
  function formatMessage(text) {
    // Basic Markdown for code blocks (```code```)
    text = text.replace(/```([\s\S]*?)```/g, (match, code) => {
        return `<pre><code>${code.trim()}</code></pre>`;
    });
    return text;
  }

  // Function to add a typing indicator for the bot
  function addTypingIndicator() {
    const messageWrapper = document.createElement('div');
    messageWrapper.classList.add('message-wrapper', 'bot');
    messageWrapper.id = 'typing-indicator-wrapper'; // Unique ID for easy removal
    messageWrapper.setAttribute('aria-label', 'Alip AI is typing');

    const avatar = document.createElement('div');
    avatar.classList.add('avatar');
    const avatarImg = document.createElement('img');
    avatarImg.src = botAvatarUrl;
    avatarImg.alt = 'Alip AI Avatar';
    avatarImg.onerror = () => { // Fallback if image fails to load
        avatar.textContent = 'AI';
        console.warn('Typing indicator avatar image failed to load. Using text fallback.');
        avatarImg.remove();
    };
    avatar.appendChild(avatarImg);

    const typingDiv = document.createElement('div');
    typingDiv.classList.add('typing-indicator');
    for(let i = 0; i < 3; i++) {
      const dot = document.createElement('span');
      dot.classList.add('typing-dot');
      typingDiv.appendChild(dot);
    }

    messageWrapper.appendChild(avatar);
    messageWrapper.appendChild(typingDiv);
    chatContainer.appendChild(messageWrapper);
    scrollToBottom();
    return messageWrapper; // Return the element to easily remove it later
  }

  // Function to remove the typing indicator
  function removeTypingIndicator() {
    const typingElem = document.getElementById('typing-indicator-wrapper');
    if(typingElem) {
      typingElem.remove();
    }
  }

  // Function to simulate bot typing out a message character by character
  async function typeBotMessage(text) {
    const messageWrapper = document.createElement('div');
    messageWrapper.classList.add('message-wrapper', 'bot');

    const avatar = document.createElement('div');
    avatar.classList.add('avatar');
    const avatarImg = document.createElement('img');
    avatarImg.src = botAvatarUrl;
    avatarImg.alt = 'Alip AI Avatar';
    avatarImg.onerror = () => { // Fallback if image fails to load
        avatar.textContent = 'AI';
        console.warn('Bot message avatar image failed to load. Using text fallback.');
        avatarImg.remove();
    };
    avatar.appendChild(avatarImg);

    const messageDiv = document.createElement('div');
    messageDiv.classList.add('message');

    messageWrapper.appendChild(avatar);
    messageWrapper.appendChild(messageDiv);
    chatContainer.appendChild(messageWrapper);

    const formattedText = formatMessage(text);
    const characters = formattedText.split('');
    let currentText = '';
    for (let i = 0; i < characters.length; i++) {
      currentText += characters[i];
      messageDiv.innerHTML = currentText;
      scrollToBottom();
      await new Promise(resolve => setTimeout(resolve, 15)); // Typing speed (15ms per character)
    }
  }

  // Scrolls the chat container to the bottom
  function scrollToBottom() {
    chatContainer.scrollTop = chatContainer.scrollHeight;
    scrollToBottomBtn.classList.remove('show'); // Hide button if already at bottom
  }

  // Adjusts chat container margin-bottom dynamically based on form height
  function setDynamicMargins() {
    const formHeight = chatForm.offsetHeight;
    document.documentElement.style.setProperty('--form-height', `${formHeight}px`);
    chatContainer.style.marginBottom = `calc(var(--form-height) + 20px)`;
    // Adjust error message margin as well if visible
    if (errorDiv.style.display !== 'none') {
        errorDiv.style.marginBottom = `calc(var(--form-height) + 20px)`;
    }
  }

  // Initialize on page load
  window.addEventListener('load', () => {
    setDynamicMargins(); // Set initial dynamic margins
    // Check saved theme from localStorage
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'light') {
        document.body.classList.add('light-mode');
        darkModeToggle.checked = false; // Uncheck for light mode
    } else {
        document.body.classList.remove('light-mode');
        darkModeToggle.checked = true; // Check for dark mode (default)
    }

    // Display welcome message
    const welcomeMessage = "Halo! Gua Alip AI, asisten virtual cerdas yang siap bantu lu. Ada apa nih? Gua siap nemenin lu ngobrol, nanyain apa aja, atau sekadar curhat. Santai aja ya!";
    addMessage(welcomeMessage, 'bot');
    conversationHistory.push({ role: 'model', parts: welcomeMessage });
    document.getElementById('currentYear').textContent = new Date().getFullYear();
  });

  // Re-adjust margins on window resize
  window.addEventListener('resize', setDynamicMargins);
  // Observe changes in form height (e.g., due to font size changes, etc.)
  const resizeObserverForm = new ResizeObserver(setDynamicMargins);
  resizeObserverForm.observe(chatForm);

  // Show/hide scroll to bottom button based on scroll position
  chatContainer.addEventListener('scroll', () => {
    // Show button if scrolled up significantly
    if (chatContainer.scrollHeight - chatContainer.scrollTop > chatContainer.clientHeight + 150) {
      scrollToBottomBtn.classList.add('show');
    } else {
      scrollToBottomBtn.classList.remove('show');
    }
  });

  // Scroll to bottom button click handler
  scrollToBottomBtn.addEventListener('click', scrollToBottom);

  // Function to send message to API (dummy implementation for now)
  async function sendMessageToAPI(message) {
    // Keep only the last 10 messages for context
    const recentHistory = conversationHistory.slice(-10).map(msg => ({
        role: msg.role === 'user' ? 'user' : 'model', // Map to API's expected roles
        parts: [{text: msg.parts}]
    }));

    // Construct a simpler prompt for API
    let fullPrompt = `You are Alip AI, a smart and futuristic AI assistant. Your language style is relaxed, to the point, and cool, like chatting with a friend. Use 'lu' (you) and 'gua' (I/me) in your responses. Your answers should be short, clear, and interactive. If there are questions about programming, provide code examples (not too long, just the essentials). If a question is illogical, respond humorously but politely.`;

    const requestBody = {
        contents: [
            { role: "user", parts: [{ text: fullPrompt }] },
            ...recentHistory,
            { role: "user", parts: [{ text: message }] }
        ]
    };

    const url = 'https://api.siputzx.my.id/api/ai/gemini-pro';

    try {
      errorDiv.style.display = 'none'; // Hide any previous error
      const response = await fetch(url, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
      });

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(`HTTP error! Status: ${response.status} - ${errorData.message || response.statusText}`);
      }
      const data = await response.json();

      if(data.status === true && data.data && data.data.candidates && data.data.candidates.length > 0) {
        // Extracting text from the first part of the first candidate's content
        return data.data.candidates[0].content.parts[0].text;
      } else if (data.error) {
        errorDiv.textContent = `API Alip AI Error: ${data.error}`;
        errorDiv.style.display = 'block';
        return 'Waduh, Alip AI lagi error nih. Coba lagi bentar ya.';
      }
      return 'Gua gagal dapetin respon yang valid dari Alip AI. Coba lagi aja ya.';
    } catch (err) {
      errorDiv.textContent = `Ada masalah koneksi atau server: ${err.message}. Pastiin internet lu stabil atau coba lagi nanti.`;
      errorDiv.style.display = 'block';
      console.error("Error fetching from API:", err);
      return 'Duh, Alip AI gak bisa dihubungin nih. Coba lagi nanti ya, mungkin lagi ngopi.';
    }
  }

  // Chat form submission handler
  chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const userText = input.value.trim();
    if (!userText) return;

    addMessage(userText, 'user');
    conversationHistory.push({ role: 'user', parts: userText });

    input.value = ''; // Clear input field
    input.disabled = true; // Disable input
    chatForm.querySelector('button[type="submit"]').disabled = true; // Disable send button

    const typingIndicator = addTypingIndicator(); // Show typing indicator

    try {
      const reply = await sendMessageToAPI(userText); // Get reply from API
      removeTypingIndicator(); // Remove typing indicator
      await typeBotMessage(reply); // Type out bot message
      conversationHistory.push({ role: 'model', parts: reply }); // Add bot reply to history
    } catch (error) {
      removeTypingIndicator(); // Ensure typing indicator is removed even on error
    } finally {
      input.disabled = false; // Re-enable input
      chatForm.querySelector('button[type="submit"]').disabled = false; // Re-enable send button
      input.focus(); // Focus back on input
      scrollToBottom(); // Scroll to bottom again
    }
  });

  // Sidebar toggle button handler
  sidebarToggle.addEventListener('click', () => {
    const isOpen = sidebar.classList.toggle('open');
    sidebarToggle.querySelector('i').classList.toggle('fa-times', isOpen);
    sidebarToggle.querySelector('i').classList.toggle('fa-bars', !isOpen);
    sidebarToggle.setAttribute('aria-expanded', isOpen);
  });

  // Close sidebar when clicking outside
  document.addEventListener('click', (e) => {
    if (sidebar.classList.contains('open') && !sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) {
      sidebar.classList.remove('open');
      sidebarToggle.querySelector('i').classList.remove('fa-times');
      sidebarToggle.querySelector('i').classList.add('fa-bars');
      sidebarToggle.setAttribute('aria-expanded', false);
    }
  });

  // Clear Chat button handler
  clearChatBtn.addEventListener('click', () => {
    chatContainer.innerHTML = ''; // Clear all messages
    conversationHistory = []; // Clear conversation history
    errorDiv.style.display = 'none'; // Hide error message
    // Re-add initial welcome message
    const welcomeMessage = "Halo! Gua Alip AI, asisten virtual cerdas yang siap bantu lu. Ada apa nih? Gua siap nemenin lu ngobrol, nanyain apa aja, atau sekadar curhat. Santai aja ya!";
    addMessage(welcomeMessage, 'bot');
    conversationHistory.push({ role: 'model', parts: welcomeMessage });
    // Close sidebar after action
    sidebar.classList.remove('open');
    sidebarToggle.querySelector('i').classList.remove('fa-times');
    sidebarToggle.querySelector('i').classList.add('fa-bars');
    sidebarToggle.setAttribute('aria-expanded', false);
  });

  // New Chat button handler (same as clear chat for now)
  newChatBtn.addEventListener('click', () => {
    clearChatBtn.click(); // Simply trigger the clear chat functionality
  });

  // Download Chat button handler
  downloadChatBtn.addEventListener('click', () => {
    let chatContent = 'Riwayat Obrolan Alip AI\n\n';
    const messages = chatContainer.querySelectorAll('.message-wrapper');
    messages.forEach(msgWrapper => {
      // Skip typing indicator if it exists
      if (msgWrapper.id === 'typing-indicator-wrapper') return;

      const sender = msgWrapper.classList.contains('user') ? 'Anda' : 'Alip AI';
      // Use innerHTML to get the formatted text, then strip HTML for plain text file
      const messageHtml = msgWrapper.querySelector('.message').innerHTML;
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = messageHtml;
      const messageText = tempDiv.textContent || tempDiv.innerText; // Get plain text

      chatContent += `${sender}: ${messageText}\n\n`;
    });

    const blob = new Blob([chatContent], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `alip_ai_chat_log_${new Date().toISOString().slice(0,10)}.txt`; // Dynamic filename
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url); // Clean up URL object
    // Close sidebar after action
    sidebar.classList.remove('open');
    sidebarToggle.querySelector('i').classList.remove('fa-times');
    sidebarToggle.querySelector('i').classList.add('fa-bars');
    sidebarToggle.setAttribute('aria-expanded', false);
  });

  // Dark/Light Mode Toggle handler
  darkModeToggle.addEventListener('change', () => {
    document.body.classList.toggle('light-mode');
    // Save theme preference to localStorage
    localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
  });

  // No specific "info sections" (Tentang, Kontak) to show/hide as they are removed
  // The provided code already removes them, so the related JS functions are now obsolete
  // and have been removed from this final version.
</script>

</body>
</html>
